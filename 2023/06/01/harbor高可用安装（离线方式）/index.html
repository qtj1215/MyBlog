<!DOCTYPE html>
<html lang="zh-CN,en,default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.qintianjun.top","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="高可用方式安装harbor镜像仓库">
<meta property="og:type" content="article">
<meta property="og:title" content="harbor高可用安装（离线方式）">
<meta property="og:url" content="http://www.qintianjun.top/2023/06/01/harbor%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%EF%BC%88%E7%A6%BB%E7%BA%BF%E6%96%B9%E5%BC%8F%EF%BC%89/index.html">
<meta property="og:site_name" content="Freedom_ATX&#39;s Blog">
<meta property="og:description" content="高可用方式安装harbor镜像仓库">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/06/02/PrCRODq6YyVzGXg.png">
<meta property="og:image" content="https://s2.loli.net/2023/06/02/135g9LOMCGaDHik.png">
<meta property="og:image" content="https://s2.loli.net/2023/06/02/IwaEeVLhDtBPf2l.png">
<meta property="og:image" content="https://s2.loli.net/2023/06/02/Wk4qTaNlMyIYFCp.png">
<meta property="og:image" content="https://s2.loli.net/2023/06/02/ObWBT8hz7G5KQ1R.png">
<meta property="og:image" content="https://s2.loli.net/2023/06/02/aQBUvLKut1xGXbF.png">
<meta property="og:image" content="https://s2.loli.net/2023/06/02/Ty3kd1J9wbaPSmG.png">
<meta property="og:image" content="https://s2.loli.net/2023/06/02/wye9cEobdNJ8tfz.png">
<meta property="og:image" content="https://s2.loli.net/2023/06/02/WzE3kgGRt1Qneqr.png">
<meta property="og:image" content="https://s2.loli.net/2023/06/02/7GyXbNWIHqRDtwK.png">
<meta property="og:image" content="https://s2.loli.net/2023/06/02/FKVPfZWb72zv4ON.png">
<meta property="og:image" content="https://s2.loli.net/2023/06/02/zrGFQMiDvJcLU5X.png">
<meta property="og:image" content="https://s2.loli.net/2023/06/02/Srnlp1vymAKQsC2.png">
<meta property="og:image" content="https://s2.loli.net/2023/06/02/I7PVFRu68Gxe39N.png">
<meta property="article:published_time" content="2023-06-01T12:01:43.000Z">
<meta property="article:modified_time" content="2023-06-02T06:38:21.364Z">
<meta property="article:author" content="QinTianJun">
<meta property="article:tag" content="Ops">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/06/02/PrCRODq6YyVzGXg.png">

<link rel="canonical" href="http://www.qintianjun.top/2023/06/01/harbor%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%EF%BC%88%E7%A6%BB%E7%BA%BF%E6%96%B9%E5%BC%8F%EF%BC%89/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>harbor高可用安装（离线方式） | Freedom_ATX's Blog</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b8f33cffae5a7adb95d2bdb812879d09";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Freedom_ATX's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Freedom_ATX's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.qintianjun.top/2023/06/01/harbor%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%89%E8%A3%85%EF%BC%88%E7%A6%BB%E7%BA%BF%E6%96%B9%E5%BC%8F%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/logo.jpeg">
      <meta itemprop="name" content="QinTianJun">
      <meta itemprop="description" content="一个菜鸟的成长之路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Freedom_ATX's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          harbor高可用安装（离线方式）
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-06-01 20:01:43" itemprop="dateCreated datePublished" datetime="2023-06-01T20:01:43+08:00">2023-06-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-02 14:38:21" itemprop="dateModified" datetime="2023-06-02T14:38:21+08:00">2023-06-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ops/" itemprop="url" rel="index"><span itemprop="name">Ops</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ops/Cloud/" itemprop="url" rel="index"><span itemprop="name">Cloud</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p>本文实验参考微信公众号harbor进阶实践</p>
</blockquote>
<h2 id="1-环境说明"><a href="#1-环境说明" class="headerlink" title="1 环境说明"></a>1 环境说明</h2><h3 id="1-1-架构图"><a href="#1-1-架构图" class="headerlink" title="1.1 架构图"></a>1.1 架构图</h3><p><img src="https://s2.loli.net/2023/06/02/PrCRODq6YyVzGXg.png"></p>
<blockquote>
<p>将Harbor的redis缓存组件、PostgreSQL数据库组件迁移到系统外部做高可用，使用外部共享存储实现多个Harbor实例的数据共享，Harbor实例可横向扩展。</p>
</blockquote>
<h3 id="1-2-主机清单"><a href="#1-2-主机清单" class="headerlink" title="1.2 主机清单"></a>1.2 主机清单</h3><table>
<thead>
<tr>
<th align="left">ip地址</th>
<th align="left">主机名</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">192.168.88.131</td>
<td align="left">harbor-data</td>
<td align="left">部署Harbor实例的共享存储、外部数据库、外部缓存服务</td>
</tr>
<tr>
<td align="left">192.168.88.138</td>
<td align="left">harbo1</td>
<td align="left">Harbor实例1，8021端口</td>
</tr>
<tr>
<td align="left">192.168.88.139</td>
<td align="left">harbor2</td>
<td align="left">Harbor实例2，8021端口</td>
</tr>
<tr>
<td align="left">192.168.88.121</td>
<td align="left">&#x2F;</td>
<td align="left">负载均衡VIP,8121端口</td>
</tr>
</tbody></table>
<h3 id="1-3-服务版本"><a href="#1-3-服务版本" class="headerlink" title="1.3 服务版本"></a>1.3 服务版本</h3><table>
<thead>
<tr>
<th align="left">服务</th>
<th align="left">版本要求</th>
<th align="left">安装版本</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Harbor</td>
<td align="left">&#x2F;</td>
<td align="left">2.3.5</td>
</tr>
<tr>
<td align="left">Docker</td>
<td align="left">17.06.0+</td>
<td align="left">19.03.8</td>
</tr>
<tr>
<td align="left">Docker-compose</td>
<td align="left">1.18.0+</td>
<td align="left">v2.2.3</td>
</tr>
<tr>
<td align="left">Redis</td>
<td align="left">6.0.16</td>
<td align="left">6.2.7</td>
</tr>
</tbody></table>
<h2 id="2-主机初始化"><a href="#2-主机初始化" class="headerlink" title="2 主机初始化"></a>2 主机初始化</h2><h3 id="2-1-安装docker"><a href="#2-1-安装docker" class="headerlink" title="2.1 安装docker"></a>2.1 安装docker</h3><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">yum install -y docker-ce</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl <span class="hljs-built_in">enable</span>  --now docker</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl status docker</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF &gt; /etc/docker/daemon.json</span></span><br>&#123;<br>   &quot;registry-mirrors&quot;: [&quot;https://xcg41ct3.mirror.aliyuncs.com&quot;],<br>   &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],  <br>   &quot;registry-mirrors&quot;: [&quot;https://3hjcmqfe.mirror.aliyuncs.com&quot;], <br>   &quot;log-driver&quot;: &quot;json-file&quot;,<br>   &quot;log-opts&quot;: &#123;<br>           &quot;max-size&quot;: &quot;500m&quot;,<br>           &quot;max-file&quot;: &quot;2&quot; <br>        &#125;<br>&#125;<br>EOF <br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-string">systemctl daemon-reload</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-string">systemctl restart docker</span></span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>exec-opts”: [“native.cgroupdriver&#x3D;systemd”],     #驱动器 registry-mirrors: 镜像加速地址，可多个 max-file: log 最多保留数量 live-restore: 重启 docker 不重启容器，多用于 k8s 上</p>
</blockquote>
<h3 id="2-2-安装docker-compose"><a href="#2-2-安装docker-compose" class="headerlink" title="2.2 安装docker-compose"></a>2.2 安装docker-compose</h3><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">wget https://github.com/docker/compose/releases/download/v2.2.3/docker-compose-linux-x86_64 <span class="hljs-comment"># 下载前先确认链接有效性</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mv</span>  docker-compose-linux-x86_64 /usr/local/bin/docker-compose</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">chmod</span> +x /usr/local/bin/docker-compose</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker-compose version</span><br>Docker Compose version v2.2.3<br></code></pre></td></tr></table></figure>

<h3 id="2-3-配置内核参数"><a href="#2-3-配置内核参数" class="headerlink" title="2.3 配置内核参数"></a>2.3 配置内核参数</h3><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">modprobe br_netfilter</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> &gt;&gt; /etc/sysctl.conf &lt;&lt; <span class="hljs-string">EOF</span></span><br>net.bridge.bridge-nf-call-ip6tables = 1<br>net.bridge.bridge-nf-call-iptables = 1<br>net.ipv4.ip_forward = 1      #路由转发<br>EOF<br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-string">sysctl -p</span></span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>如果提示<code>sysctl: cannot stat /proc/sys/net/ipv4/ip_forward : No such file or director</code><br>可能是conntrack没有加载，执行<code>lsmod |grep conntrack</code> 查看，执行<code>modprobe ip_conntrack</code>加载</p>
</blockquote>
<h2 id="3-使用NFS提供外部共享存储"><a href="#3-使用NFS提供外部共享存储" class="headerlink" title="3 使用NFS提供外部共享存储"></a>3 使用NFS提供外部共享存储</h2><h3 id="3-1-部署NFS服务端"><a href="#3-1-部署NFS服务端" class="headerlink" title="3.1 部署NFS服务端"></a>3.1 部署NFS服务端</h3><ul>
<li><p>安装并启动nfs</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">yum  install -y  nfs-utils</span> <br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl start nfs &amp;&amp; systemctl <span class="hljs-built_in">enable</span> nfs  &amp;&amp; systemctl status nfs</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">chkconfig nfs on              <span class="hljs-comment">#设置为开机自启</span></span><br></code></pre></td></tr></table></figure>
</li>
<li><p>创建共享目录</p>
</li>
</ul>
<p>客户端的数据将远程存入到共享目录下。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">[root@harbor-data ~]# mkdir -p /data/harbor_data<br></code></pre></td></tr></table></figure>

<ul>
<li><p>修改配置</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">[root@harbor-data harbor_data]# cat /etc/exports<br>/data/harbor_data 192.168.88.0/24(rw,no_root_squash)<br></code></pre></td></tr></table></figure>
</li>
<li><p>重启nfs服务</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">[root@harbor-data harbor_data]# systemctl restart nfs<br>[root@harbor-data harbor_data]# systemctl status nfs<br>● nfs-server.service - NFS server and services<br>   Loaded: loaded (/usr/lib/systemd/system/nfs-server.service; enabled; vendor preset: disabled)<br>   Active: active (exited) since Fri 2023-04-07 06:50:46 CST; 3s ago<br>  Process: 2020 ExecStopPost=/usr/sbin/exportfs -f (code=exited, status=0/SUCCESS)<br>  Process: 2017 ExecStopPost=/usr/sbin/exportfs -au (code=exited, status=0/SUCCESS)<br>  Process: 2015 ExecStop=/usr/sbin/rpc.nfsd 0 (code=exited, status=0/SUCCESS)<br>  Process: 2050 ExecStartPost=/bin/sh -c if systemctl -q is-active gssproxy; then systemctl reload gssproxy ; fi (code=exited, status=0/SUCCESS)<br>  Process: 2035 ExecStart=/usr/sbin/rpc.nfsd $RPCNFSDARGS (code=exited, status=0/SUCCESS)<br>  Process: 2034 ExecStartPre=/usr/sbin/exportfs -r (code=exited, status=0/SUCCESS)<br> Main PID: 2035 (code=exited, status=0/SUCCESS)<br>    Tasks: 0<br>   Memory: 0B<br>   CGroup: /system.slice/nfs-server.service<br><br>Apr 07 06:50:45 harbor-data systemd[1]: Starting NFS server and services...<br>Apr 07 06:50:46 harbor-data systemd[1]: Started NFS server and services.<br><br></code></pre></td></tr></table></figure>
</li>
<li><p>检查共享目录信息</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">[root@harbor-data harbor_data]# showmount -e localhost<br>Export list for localhost:<br>/data/harbor_data 192.168.88.0/24<br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="3-2-部署客户端"><a href="#3-2-部署客户端" class="headerlink" title="3.2 部署客户端"></a>3.2 部署客户端</h3><p>在harbor1和harbor2上操作</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">yum -y install nfs-utils</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl start nfs-utils &amp;&amp;  systemctl <span class="hljs-built_in">enable</span> nfs-utils &amp;&amp; systemctl status  nfs-utils</span><br></code></pre></td></tr></table></figure>


<h3 id="3-3-客户端挂在NFS共享存储"><a href="#3-3-客户端挂在NFS共享存储" class="headerlink" title="3.3 客户端挂在NFS共享存储"></a>3.3 客户端挂在NFS共享存储</h3><p>在 harbor1 和 harbor2 节点操作, 创建实例的存储目录，然后挂载到 NFS。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">[root@harbor1 harbor]# mkdir -pv /data/harbor_data<br>mkdir: created directory ‘/data/harbor_data’<br>[root@harbor1 harbor]# cat &lt;&lt; EOF &gt;&gt; /etc/fstab <br><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">192.168.88.131:/data/harbor_data /data/harbor_data nfs  defaults  0 0</span><br><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">EOF</span><br>[root@harbor1 harbor]# mount -a<br></code></pre></td></tr></table></figure>

<blockquote>
<p>挂载格式：NFSIP: 共享目录   本地目录  nfs defaults 0 0</p>
</blockquote>
<p>测试是否可以正常使用<br><img src="https://s2.loli.net/2023/06/02/135g9LOMCGaDHik.png"><br><img src="https://s2.loli.net/2023/06/02/IwaEeVLhDtBPf2l.png"></p>
<h2 id="4-部署Redis缓存服务（源码）"><a href="#4-部署Redis缓存服务（源码）" class="headerlink" title="4 部署Redis缓存服务（源码）"></a>4 部署Redis缓存服务（源码）</h2><p>在harbor-data上部署redis，为harbor1和harbor2实例提供外部redis缓存服务</p>
<h3 id="4-1-下载安装包"><a href="#4-1-下载安装包" class="headerlink" title="4.1 下载安装包"></a>4.1 下载安装包</h3><p><code>$ wget https://download.redis.io/releases/redis-6.2.7.tar.gz</code></p>
<h3 id="4-2-安装依赖包"><a href="#4-2-安装依赖包" class="headerlink" title="4.2 安装依赖包"></a>4.2 安装依赖包</h3><p><code>$ yum  install  -y  gcc  gcc-c++</code></p>
<h3 id="4-3-源码编译"><a href="#4-3-源码编译" class="headerlink" title="4.3 源码编译"></a>4.3 源码编译</h3><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> -p /data/app/</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">tar zxvf  redis-6.2.7.tar.gz  -C /data/app</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> /data/app/redis-6.2.7/</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">make   <span class="hljs-comment">#编译</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">make  install   <span class="hljs-comment">#安装, 这里不加参数默认就是/usr/local/bin目录下</span></span><br></code></pre></td></tr></table></figure>

<h3 id="4-4-修改配置文件"><a href="#4-4-修改配置文件" class="headerlink" title="4.4 修改配置文件"></a>4.4 修改配置文件</h3><p>redis 默认只支持本地使用, 本处需要修改几个参数：</p>
<ul>
<li>外部可连接;  </li>
<li>redis 启动方式;</li>
<li>redis 远程连接密码；<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">bind 192.168.88.** #75行，允许内网主机连接；<br>daemonize yes       #259行，将no修改为yes，使redis可以使用守护进程方式启动；<br>requirepass 123456   #903行，设置redis连接的auth密码<br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="4-5-启动redis服务"><a href="#4-5-启动redis服务" class="headerlink" title="4.5 启动redis服务"></a>4.5 启动redis服务</h3><p>前面配置了使用守护进程方式启动，所以直接使用systemctl 则可以启动redis服务</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">[root@habor-data redis-6.2.7]# pwd<br>/data/app/redis-6.2.7<br>[root@habor-data redis-6.2.7]# redis-server redis.conf<br></code></pre></td></tr></table></figure>

<h3 id="4-6-服务验证"><a href="#4-6-服务验证" class="headerlink" title="4.6 服务验证"></a>4.6 服务验证</h3><p>1）查看redis服务版本</p>
<figure class="highlight avrasm"><table><tr><td class="code"><pre><code class="hljs avrasm">$ redis-<span class="hljs-keyword">cli</span> -v  <br>redis-<span class="hljs-keyword">cli</span> <span class="hljs-number">6.2</span><span class="hljs-number">.7</span><br></code></pre></td></tr></table></figure>

<p>2）查看端口</p>
<p>redis默认监听6379端口</p>
<figure class="highlight tap"><table><tr><td class="code"><pre><code class="hljs tap">[root@habor-data ~]<span class="hljs-comment"># ps -ef | grep 6379</span><br>root      <span class="hljs-number"> 6504 </span>    <span class="hljs-number"> 1 </span><span class="hljs-number"> 0 </span>04:52 ?        00:00:47 redis-server *:6379<br>root      <span class="hljs-number"> 8882 </span> <span class="hljs-number"> 8864 </span><span class="hljs-number"> 0 </span>15:12 pts/0    00:00:00 grep --color=auto 6379<br></code></pre></td></tr></table></figure>

<p>3）客户端连接Redis<br><code>harbor1</code>和<code>harbor2</code>作为redis客户端</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><code class="hljs gradle">$ which redis-cli      #查看redis-cli工具位置  <br><span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>redis-cli<br>[root@habor-data ~]# scp <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>redis-cli <span class="hljs-number">192.168</span>.<span class="hljs-number">88.138</span>:<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span><br>[root@habor-data ~]# scp <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>redis-cli <span class="hljs-number">192.168</span>.<span class="hljs-number">88.139</span>:<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span><br></code></pre></td></tr></table></figure>

<p>客户端使用redis-cli工具连接redis服务器</p>
<figure class="highlight accesslog"><table><tr><td class="code"><pre><code class="hljs accesslog"><span class="hljs-string">[root@harbor1 ~]</span># redis-cli -h <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">88</span>.<span class="hljs-number">131</span> <br><span class="hljs-number">192.168.88.131:6379</span>&gt; auth <span class="hljs-number">123456</span><br>OK<br></code></pre></td></tr></table></figure>
<blockquote>
<p>也可以使用-a参数指定密码</p>
</blockquote>
<h2 id="5-部署PostgreSQL外部存储服务（源码）"><a href="#5-部署PostgreSQL外部存储服务（源码）" class="headerlink" title="5 部署PostgreSQL外部存储服务（源码）"></a>5 部署PostgreSQL外部存储服务（源码）</h2><h3 id="5-1-新建postgres用户"><a href="#5-1-新建postgres用户" class="headerlink" title="5.1 新建postgres用户"></a>5.1 新建postgres用户</h3><p>默认超级用户（root）不能启动postgresql，需要手动建用户postgres。</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@habor-data ~]</span><span class="hljs-comment"># useradd postgres</span><br><span class="hljs-section">[root@habor-data ~]</span><span class="hljs-comment"># id postgres</span><br><span class="hljs-attr">uid</span>=<span class="hljs-number">1000</span>(postgres) gid=<span class="hljs-number">1000</span>(postgres) groups=<span class="hljs-number">1000</span>(postgres)<br></code></pre></td></tr></table></figure>

<h3 id="5-2-安装依赖包"><a href="#5-2-安装依赖包" class="headerlink" title="5.2 安装依赖包"></a>5.2 安装依赖包</h3><figure class="highlight nsis"><table><tr><td class="code"><pre><code class="hljs nsis">$ yum -y install readline-devel  <span class="hljs-literal">zlib</span>-devel  gcc <span class="hljs-literal">zlib</span><br></code></pre></td></tr></table></figure>

<h3 id="5-3-下载解压源码包"><a href="#5-3-下载解压源码包" class="headerlink" title="5.3 下载解压源码包"></a>5.3 下载解压源码包</h3><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">$ wget https:<span class="hljs-regexp">//</span>ftp.postgresql.org<span class="hljs-regexp">/pub/</span>source<span class="hljs-regexp">/v13.5/</span>postgresql-<span class="hljs-number">13.5</span>.tar.gz --no-check-certificate  <br>$ tar zxvf postgresql-<span class="hljs-number">13.5</span>.tar.gz   -C  <span class="hljs-regexp">/app/</span><br></code></pre></td></tr></table></figure>

<h3 id="5-4-编译安装"><a href="#5-4-编译安装" class="headerlink" title="5.4 编译安装"></a>5.4 编译安装</h3><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">$ cd <span class="hljs-regexp">/data/</span>app<span class="hljs-regexp">/postgresql-13.5/</span>  <br>$ .<span class="hljs-regexp">/configure  --prefix=/u</span>sr<span class="hljs-regexp">/local/</span>postgresql  <br>$ make &amp;&amp; make install<br></code></pre></td></tr></table></figure>

<h3 id="5-5-创建数据目录"><a href="#5-5-创建数据目录" class="headerlink" title="5.5 创建数据目录"></a>5.5 创建数据目录</h3><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">$ mkdir -p <span class="hljs-regexp">/data/</span>postgresql/data  <br>$ chown -R postgres:postgres <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/postgresql/</span>  <br>$ chown -R postgres:postgres <span class="hljs-regexp">/data/</span>postgresql<span class="hljs-regexp">/data/</span><br></code></pre></td></tr></table></figure>

<h3 id="5-6-设置postgres环境变量"><a href="#5-6-设置postgres环境变量" class="headerlink" title="5.6 设置postgres环境变量"></a>5.6 设置postgres环境变量</h3><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">[root@harbor-data postgresql-13.5]# su  - postgres  <br>[postgres@harbor-data ~]$ vim  ~/.bash_profile  <br>PGHOME=/usr/local/postgresql   #psql安装目录  <br>export PGHOME  <br>PGDATA=/data/postgresql/data    #数据库目录  <br>export PGDATA  <br>PATH=$PATH:$HOME/bin:$HOME/.local/bin:$PGHOME/bin  <br>export PATH  <br>[postgres@harbor-data ~]$ source ./.bash_profile  <br>[postgres@harbor-data ~]$ which psql  <br>/usr/local/postgresql/bin/psql<br></code></pre></td></tr></table></figure>

<p>查看版本 [postgres@harbor-data ~]$ psql -V psql (PostgreSQL) 13.5</p>
<h3 id="5-7-初始化数据库"><a href="#5-7-初始化数据库" class="headerlink" title="5.7 初始化数据库"></a>5.7 初始化数据库</h3><blockquote>
<p>由于 Red Hat 系列发行版的政策，PostgreSQL 安装不会启用自动启动或自动初始化数据库。要完成数据库安装，您需要根据您的发行版执行以下步骤：</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql">[postgres<span class="hljs-variable">@habor</span><span class="hljs-operator">-</span>data postgresql]$ initdb<br>The files belonging <span class="hljs-keyword">to</span> this database <span class="hljs-keyword">system</span> will be owned <span class="hljs-keyword">by</span> <span class="hljs-keyword">user</span> &quot;postgres&quot;.<br>This <span class="hljs-keyword">user</span> must also own the server process.<br><br>The database cluster will be initialized <span class="hljs-keyword">with</span> locale &quot;en_US.UTF-8&quot;.<br>The <span class="hljs-keyword">default</span> database encoding has accordingly been <span class="hljs-keyword">set</span> <span class="hljs-keyword">to</span> &quot;UTF8&quot;.<br>The <span class="hljs-keyword">default</span> text <span class="hljs-keyword">search</span> configuration will be <span class="hljs-keyword">set</span> <span class="hljs-keyword">to</span> &quot;english&quot;.<br><br>Data page checksums <span class="hljs-keyword">are</span> disabled.<br><br>fixing permissions <span class="hljs-keyword">on</span> existing directory <span class="hljs-operator">/</span>data<span class="hljs-operator">/</span>postgresql<span class="hljs-operator">/</span>data ... ok<br>creating subdirectories ... ok<br>selecting <span class="hljs-keyword">dynamic</span> shared memory implementation ... posix<br>selecting <span class="hljs-keyword">default</span> max_connections ... <span class="hljs-number">100</span><br>selecting <span class="hljs-keyword">default</span> shared_buffers ... <span class="hljs-number">128</span>MB<br>selecting <span class="hljs-keyword">default</span> <span class="hljs-type">time</span> zone ... Asia<span class="hljs-operator">/</span>Shanghai<br>creating configuration files ... ok<br><span class="hljs-keyword">running</span> bootstrap script ... ok<br>performing post<span class="hljs-operator">-</span>bootstrap initialization ... ok<br>syncing data <span class="hljs-keyword">to</span> disk ... ok<br><br>initdb: warning: enabling &quot;trust&quot; authentication <span class="hljs-keyword">for</span> <span class="hljs-keyword">local</span> connections<br>You can change this <span class="hljs-keyword">by</span> editing pg_hba.conf <span class="hljs-keyword">or</span> <span class="hljs-keyword">using</span> the option <span class="hljs-operator">-</span>A, <span class="hljs-keyword">or</span><br><span class="hljs-comment">--auth-local and --auth-host, the next time you run initdb.</span><br><br>Success. You can now <span class="hljs-keyword">start</span> the database server <span class="hljs-keyword">using</span>:<br><br>    pg_ctl <span class="hljs-operator">-</span>D <span class="hljs-operator">/</span>data<span class="hljs-operator">/</span>postgresql<span class="hljs-operator">/</span>data <span class="hljs-operator">-</span>l logfile <span class="hljs-keyword">start</span><br></code></pre></td></tr></table></figure>

<h3 id="5-8-启动PostgreSQL"><a href="#5-8-启动PostgreSQL" class="headerlink" title="5.8 启动PostgreSQL"></a>5.8 启动PostgreSQL</h3><p>根据刚才初始化成功后的提示执行启动命令！</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><code class="hljs powershell">[<span class="hljs-type">postgres</span>@<span class="hljs-type">habor</span>-<span class="hljs-type">data</span> <span class="hljs-type">postgresql</span>]<span class="hljs-variable">$</span> pg_ctl <span class="hljs-literal">-D</span> /<span class="hljs-keyword">data</span>/postgresql/<span class="hljs-keyword">data</span> <span class="hljs-literal">-l</span> logfile <span class="hljs-built_in">start</span><br>waiting <span class="hljs-keyword">for</span> server to <span class="hljs-built_in">start</span>.... done<br>server started<br></code></pre></td></tr></table></figure>

<h3 id="5-9-设置（修改）Postgresql密码"><a href="#5-9-设置（修改）Postgresql密码" class="headerlink" title="5.9 设置（修改）Postgresql密码"></a>5.9 设置（修改）Postgresql密码</h3><blockquote>
<p>默认psql本地登录是不需要密码的，即使我们设置了密码，也不需要密码就能登录。应为配置文件pg_hba.conf中的local设置为trust , 为了安全我们修改为 password，就是使用密码才能登陆，（当我们忘记密码的时间，也可以使用这用方式，先设置为trust之后，修改密码，然后在设置为password。）</p>
</blockquote>
<figure class="highlight livescript"><table><tr><td class="code"><pre><code class="hljs livescript">[postgres@habor-data postgresql]$ psql<br>psql (<span class="hljs-number">13.5</span>)<br>Type <span class="hljs-string">&quot;help&quot;</span> <span class="hljs-keyword">for</span> help.<br><br>postgres=<span class="hljs-comment"># \password</span><br>Enter <span class="hljs-keyword">new</span> password: <br>Enter <span class="hljs-literal">it</span> again: <br>postgres=<span class="hljs-comment"># \q</span><br></code></pre></td></tr></table></figure>

<h3 id="5-10-设置可远程登录PostgreSQL"><a href="#5-10-设置可远程登录PostgreSQL" class="headerlink" title="5.10  设置可远程登录PostgreSQL"></a>5.10  设置可远程登录PostgreSQL</h3><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">[postgres@harbor-data ~]$ vim /data/postgresql/data/postgresql.conf  <br>listen_addresses = <span class="hljs-string">&#x27;*&#x27;</span>    #<span class="hljs-number">60</span>行，监听所有地址  <br>[postgres@harbor-data ~]$ vim + /data/postgresql/data/pg_hba.conf  <br><span class="hljs-keyword">local</span>   <span class="hljs-keyword">all</span>             <span class="hljs-keyword">all</span>                                 <span class="hljs-keyword">password</span>  <br>host    <span class="hljs-keyword">all</span>             <span class="hljs-keyword">all</span>             <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">0</span>            <span class="hljs-keyword">password</span>  <br>host    <span class="hljs-keyword">all</span>             <span class="hljs-keyword">all</span>             ::<span class="hljs-number">1</span>/<span class="hljs-number">128</span>             <span class="hljs-keyword">password</span><br></code></pre></td></tr></table></figure>

<h3 id="5-11-重启PostgreSQL"><a href="#5-11-重启PostgreSQL" class="headerlink" title="5.11 重启PostgreSQL"></a>5.11 重启PostgreSQL</h3><figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">[postgres@habor-data postgresql]$ pg_ctl -D /data/postgresql/data -l logfile restart<br>waiting <span class="hljs-keyword">for</span><span class="hljs-built_in"> server </span><span class="hljs-keyword">to</span> shut down<span class="hljs-built_in">..</span><span class="hljs-built_in">..</span> done<span class="hljs-built_in"></span><br><span class="hljs-built_in">server </span>stopped<br>waiting <span class="hljs-keyword">for</span><span class="hljs-built_in"> server </span><span class="hljs-keyword">to</span> start<span class="hljs-built_in">..</span><span class="hljs-built_in">..</span> done<span class="hljs-built_in"></span><br><span class="hljs-built_in">server </span>started<br></code></pre></td></tr></table></figure>

<h3 id="5-12-创建数据库"><a href="#5-12-创建数据库" class="headerlink" title="5.12 创建数据库"></a>5.12 创建数据库</h3><p>Harbor 2.3.5需要创建的数据库：</p>
<ul>
<li><strong>notaryserver</strong></li>
<li><strong>notarysigner</strong></li>
<li><strong>registry</strong></li>
</ul>
<blockquote>
<p>目前Harbor仅支持PostgraSQL数据库，需要手动在外部的PostgreSQL上创建registry、notary_signer、notary_servers三个数据库，Harbor启动时会自动在对应数据库下生成表。</p>
</blockquote>
<blockquote>
<p>因为本处主要是演示环境，PostgreSQL数据库的用户就以超级管理员<code>postgres</code>为例，如果是生产环境，建议新建用户，并授予harbor、notary_signer、notary_servers三个数据库相对应的权限。</p>
</blockquote>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">[postgres@habor-data postgresql]$ psql<br>psql (<span class="hljs-number">13.5</span>)<br><span class="hljs-keyword">Type</span> &quot;help&quot; <span class="hljs-keyword">for</span> help.<br><br>postgres=# <span class="hljs-keyword">create</span> <span class="hljs-keyword">database</span> registry;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span><br>postgres=# <span class="hljs-keyword">create</span> <span class="hljs-keyword">database</span> notary_signer;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span><br>postgres=# <span class="hljs-keyword">create</span> <span class="hljs-keyword">database</span> notary_servers;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span><br>postgres=# <br>postgres=# \q<br></code></pre></td></tr></table></figure>

<h2 id="6-负载均衡设置（Nginx-Keepalived）"><a href="#6-负载均衡设置（Nginx-Keepalived）" class="headerlink" title="6 负载均衡设置（Nginx + Keepalived）"></a>6 负载均衡设置（Nginx + Keepalived）</h2><blockquote>
<p>使用keepalived和Nginx实现harbor的高可用。在<code>harbor1</code>和<code>harbor2</code>节点上安装keepalived服务来提供VIP实现负载均衡。Nginx服务则实现将来到VIP的请求转发到后端服务器组harbor</p>
</blockquote>
<h3 id="6-1-安装nginx和keepalived"><a href="#6-1-安装nginx和keepalived" class="headerlink" title="6.1 安装nginx和keepalived"></a>6.1 安装nginx和keepalived</h3><p>在harbor1和harbor2操作</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">$ wget -O <span class="hljs-regexp">/etc/yum</span>.repos.d<span class="hljs-regexp">/epel.repo http:/</span><span class="hljs-regexp">/mirrors.aliyun.com/</span>repo/epel-<span class="hljs-number">7</span>.repo$ yum install -y nginx keepalived$ yum -y install nginx-all-modules.noarch     <span class="hljs-comment">#安装nginx的stream模块</span><br></code></pre></td></tr></table></figure>

<p>nginx从1.9.0开始新增了steam模块，用来实现四层协议的转发、代理、负载均衡等。二进制安装的nginx则在.&#x2F;configure时添加–with-stream参数来安装stream模块。</p>
<h3 id="6-2-修改nginx配置文件"><a href="#6-2-修改nginx配置文件" class="headerlink" title="6.2 修改nginx配置文件"></a>6.2 修改nginx配置文件</h3><p>在harbor1和harbor2的Nginx服务配置文件一样。</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># For more information on configuration, see:</span><br><span class="hljs-comment">#   * Official English Documentation: http://nginx.org/en/docs/</span><br><span class="hljs-comment">#   * Official Russian Documentation: http://nginx.org/ru/docs/</span><br><br><span class="hljs-attribute">user</span> nginx;<br><span class="hljs-attribute">worker_processes</span> auto;<br><span class="hljs-attribute">error_log</span> /var/log/nginx/<span class="hljs-literal">error</span>.log;<br><span class="hljs-attribute">pid</span> /run/nginx.pid;<br><br><span class="hljs-comment"># Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.</span><br><span class="hljs-attribute">include</span> /usr/share/nginx/modules/<span class="hljs-regexp">*.conf</span>;<br><br><span class="hljs-section">events</span> &#123;<br>    <span class="hljs-attribute">worker_connections</span> <span class="hljs-number">1024</span>;<br>&#125;<br><br><span class="hljs-section">stream</span> &#123;<br>  <span class="hljs-attribute">log_format</span> main <span class="hljs-string">&#x27;<span class="hljs-variable">$remote_addr</span> <span class="hljs-variable">$upstream_addr</span> - [<span class="hljs-variable">$time_local</span>] <span class="hljs-variable">$status</span> <span class="hljs-variable">$upstream_bytes_sent</span>&#x27;</span>;<br>   <span class="hljs-section">upstream</span> harbor&#123;<br>       <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.88.138:8021</span>;   <span class="hljs-comment"># harbor1</span><br>       <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.88.139:8021</span>;   <span class="hljs-comment"># harbor2</span><br>   &#125;<br>   <span class="hljs-section">server</span> &#123;<br>       <span class="hljs-attribute">listen</span>  <span class="hljs-number">8121</span>;  <span class="hljs-comment">#由于nginx与harbor节点复用，这个监听端口不能是8021，否则会冲突</span><br>       <span class="hljs-attribute">proxy_pass</span> harbor;<br>   &#125;<br>&#125;<br><br><span class="hljs-section">http</span> &#123;<br>    <span class="hljs-attribute">log_format</span>  main  <span class="hljs-string">&#x27;<span class="hljs-variable">$remote_addr</span> - <span class="hljs-variable">$remote_user</span> [<span class="hljs-variable">$time_local</span>] &quot;<span class="hljs-variable">$request</span>&quot; &#x27;</span><br>                      <span class="hljs-string">&#x27;<span class="hljs-variable">$status</span> <span class="hljs-variable">$body_bytes_sent</span> &quot;<span class="hljs-variable">$http_referer</span>&quot; &#x27;</span><br>                      <span class="hljs-string">&#x27;&quot;<span class="hljs-variable">$http_user_agent</span>&quot; &quot;<span class="hljs-variable">$http_x_forwarded_for</span>&quot;&#x27;</span>;<br><br>    <span class="hljs-attribute">access_log</span>  /var/log/nginx/access.log  main;<br><br>    <span class="hljs-attribute">sendfile</span>            <span class="hljs-literal">on</span>;<br>    <span class="hljs-attribute">tcp_nopush</span>          <span class="hljs-literal">on</span>;<br>    <span class="hljs-attribute">tcp_nodelay</span>         <span class="hljs-literal">on</span>;<br>    <span class="hljs-attribute">keepalive_timeout</span>   <span class="hljs-number">65</span>;<br>    <span class="hljs-attribute">types_hash_max_size</span> <span class="hljs-number">4096</span>;<br><br>    <span class="hljs-attribute">include</span>             /etc/nginx/mime.types;<br>    <span class="hljs-attribute">default_type</span>        application/octet-stream;<br><br>    <span class="hljs-comment"># Load modular configuration files from the /etc/nginx/conf.d directory.</span><br>    <span class="hljs-comment"># See http://nginx.org/en/docs/ngx_core_module.html#include</span><br>    <span class="hljs-comment"># for more information.</span><br>    <span class="hljs-attribute">include</span> /etc/nginx/conf.d/<span class="hljs-regexp">*.conf</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>检测nginx配置文件语法</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><code class="hljs gradle">$ nginx -t<br>nginx: the configuration <span class="hljs-keyword">file</span> <span class="hljs-regexp">/etc/</span>nginx<span class="hljs-regexp">/nginx.conf syntax is oknginx: configuration file /</span>etc<span class="hljs-regexp">/nginx/</span>nginx.conf test is successful<br></code></pre></td></tr></table></figure>

<h3 id="6-3-修改keepalived-配置"><a href="#6-3-修改keepalived-配置" class="headerlink" title="6.3 修改keepalived 配置"></a>6.3 修改keepalived 配置</h3><p>本处以harbor1为keepalived服务的主节点，harbor2为keepalived的备节点，主备节点的keepalived的文件配置不一样</p>
<h4 id="1-主节点（harbor1）"><a href="#1-主节点（harbor1）" class="headerlink" title="1)主节点（harbor1）"></a>1)主节点（harbor1）</h4><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">[root@harbor1 ~]# cat /etc/keepalived/keepalived.conf<br>! Configuration File for keepalived<br><br>global_defs &#123;<br>   notification_email &#123;<br>    454536188@qq.com<br>   &#125;<br>   router_id master1<br>&#125;<br><br>vrrp_instance lidabai &#123;<br>    state MASTER<br>    interface ens33<br>    mcast_src_ip 192.168.88.138<br>    virtual_router_id 107<br>    priority 100<br>    advert_int 1<br>    nopreempt<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 1111<br>    &#125;<br>    virtual_ipaddress &#123;<br>        192.168.88.111/24  #虚拟VIP地址<br>    &#125;<br>    track_script &#123;<br>        chk_nginx<br>    &#125;<br>&#125;<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#### 健康检查</span></span><br>vrrp_script chk_nginx &#123;      <br>    script &quot;/etc/keepalived/check_nginx.sh&quot;<br>    interval 2<br>    weight -20<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-备节点（harbo2）"><a href="#2-备节点（harbo2）" class="headerlink" title="2)备节点（harbo2）"></a>2)备节点（harbo2）</h4><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">[root@harbor2 ~]# cat /etc/keepalived/keepalived.conf<br>! Configuration File for keepalived<br><br>global_defs &#123;<br>   notification_email &#123;<br>     454536188@qq.com<br>   &#125;<br>   router_id master2<br>&#125;<br><br>vrrp_instance lidabai &#123;<br>    state BACKUP<br>    interface ens33<br>    mcast_src_ip 192.168.88.139<br>    virtual_router_id 107<br>    priority 80    #权重<br>    advert_int 1<br>    nopreempt<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 1111<br>    &#125;<br>    virtual_ipaddress &#123;<br>        192.168.88.111/24<br>    &#125;<br>    track_script &#123;<br>    chk_nginx<br>    &#125;<br>&#125;<br>vrrp_script chk_nginx &#123;<br>  script &quot;/etc/keepalived/check_nginx.sh&quot;<br>  interval 2<br>  weight -20<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="6-4-编写健康检查脚本"><a href="#6-4-编写健康检查脚本" class="headerlink" title="6.4 编写健康检查脚本"></a>6.4 编写健康检查脚本</h3><p>在harbor1,harbor2添加</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">[root@harbor2 ~]# cat /etc/keepalived/check_nginx.sh <br><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">1、判断Nginx是否存活</span><br>counter=`ps -C nginx --no-header | wc -l`<br>if [ $counter -eq 0 ]; then<br>    #2、如果不存活则尝试启动Nginx<br>    service nginx start<br>    sleep 2<br>    #3、等待2秒后再次获取一次Nginx状态<br>    counter=`ps -C nginx --no-header | wc -l`<br>    #4、再次进行判断，如Nginx还不存活则停止Keepalived，让地址进行漂移<br>    if [ $counter -eq 0 ]; then<br>        service  keepalived stop<br>    fi<br>fi<br></code></pre></td></tr></table></figure>

<h3 id="6-5-启动服务"><a href="#6-5-启动服务" class="headerlink" title="6.5 启动服务"></a>6.5 启动服务</h3><p>先启动master1和master2节点上的nginx服务，再启动keepalived服务</p>
<h4 id="1）启动nginx服务"><a href="#1）启动nginx服务" class="headerlink" title="1）启动nginx服务"></a>1）启动nginx服务</h4><figure class="highlight css"><table><tr><td class="code"><pre><code class="hljs css"><span class="hljs-selector-attr">[root@harbor1 ~]</span># systemctl enable <span class="hljs-attr">--now</span> nginx   #启动nginx服务并设置开机自启<span class="hljs-selector-attr">[root@harbor2 ~]</span># systemctl enable <span class="hljs-attr">--now</span> nginx<span class="hljs-selector-attr">[root@harbor1 ~]</span># systemctl status nginx<span class="hljs-selector-class">.service</span> <span class="hljs-selector-attr">[root@harbor2 ~]</span># systemctl status nginx<span class="hljs-selector-class">.service</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>如果报错<code> [emerg] bind() to 0.0.0.0:XXXX failed (13: Permission denied)</code> 并且是root用户的话，可以检查是否开启了selinux</p>
</blockquote>
<h4 id="2）启动keepalived服务"><a href="#2）启动keepalived服务" class="headerlink" title="2）启动keepalived服务"></a>2）启动keepalived服务</h4><figure class="highlight css"><table><tr><td class="code"><pre><code class="hljs css"><span class="hljs-selector-attr">[root@harbor1 ~]</span># systemctl enable <span class="hljs-attr">--now</span> keepalived<span class="hljs-selector-attr">[root@harbor2 ~]</span># systemctl enable <span class="hljs-attr">--now</span> keepalived<span class="hljs-selector-attr">[root@harbor1 ~]</span># systemctl status keepalived<span class="hljs-selector-class">.service</span><span class="hljs-selector-attr">[root@harbor2 ~]</span># systemctl status keepalived<span class="hljs-selector-class">.service</span><br></code></pre></td></tr></table></figure>

<h3 id="6-6-查看VIP"><a href="#6-6-查看VIP" class="headerlink" title="6.6 查看VIP"></a>6.6 查看VIP</h3><p>在harbor1节点查看VIP是否成功绑定。</p>
<p><img src="https://s2.loli.net/2023/06/02/Wk4qTaNlMyIYFCp.png"></p>
<blockquote>
<p>通过ifconfig是无法查看到VIP的，通过<code>hostname -I</code>命令也可以查看到VIP。</p>
</blockquote>
<h2 id="7-部署harbor实例"><a href="#7-部署harbor实例" class="headerlink" title="7 部署harbor实例"></a>7 部署harbor实例</h2><h3 id="7-1-在harbor1-主机上部署harbor服务"><a href="#7-1-在harbor1-主机上部署harbor服务" class="headerlink" title="7.1 在harbor1 主机上部署harbor服务"></a>7.1 在harbor1 主机上部署harbor服务</h3><h4 id="1-）下载解压离线安装包"><a href="#1-）下载解压离线安装包" class="headerlink" title="1 ）下载解压离线安装包"></a>1 ）下载解压离线安装包</h4><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">$ mkdir /app   <span class="hljs-comment">#创建安装目录  </span><br>$ wget https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/goharbor/</span>harbor<span class="hljs-regexp">/releases/</span>download<span class="hljs-regexp">/v2.5.0/</span>harbor-offline-installer-v2.<span class="hljs-number">3.5</span>.tgz  <br>$ tar zxvf harbor-offline-installer-v2.<span class="hljs-number">5.0</span>.tgz  -C  <span class="hljs-regexp">/app/</span><br></code></pre></td></tr></table></figure>

<h4 id="2）修改配置文件"><a href="#2）修改配置文件" class="headerlink" title="2）修改配置文件"></a>2）修改配置文件</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">hostname:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.88</span><span class="hljs-number">.138</span><br><span class="hljs-attr">http:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8021</span><br><span class="hljs-comment">#取消https安全加密访问方式：  </span><br><span class="hljs-comment">#https:  </span><br><span class="hljs-comment">#  port: 443  </span><br><span class="hljs-comment">#  certificate: /your/certificate/path  </span><br><span class="hljs-comment">#  private_key: /your/private/key/path</span><br><span class="hljs-comment">## 启用外部代理，启用后hostname将不再使用</span><br><span class="hljs-attr">external_url:</span> <span class="hljs-string">https://192.168.88.111:8121</span><br><span class="hljs-attr">harbor_admin_password:</span> <span class="hljs-string">Harbor12345</span><br><span class="hljs-attr">database:</span><br>  <span class="hljs-attr">password:</span> <span class="hljs-string">root123</span><br>  <span class="hljs-attr">max_idle_conns:</span> <span class="hljs-number">100</span><br>  <span class="hljs-attr">max_open_conns:</span> <span class="hljs-number">900</span><br><span class="hljs-comment">## 配置共享存储，即挂载的NFS目录</span><br><span class="hljs-attr">data_volume:</span> <span class="hljs-string">/data/harbor_data</span><br><span class="hljs-attr">trivy:</span><br>  <span class="hljs-attr">ignore_unfixed:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">skip_update:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">offline_scan:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">insecure:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">jobservice:</span><br>  <span class="hljs-attr">max_job_workers:</span> <span class="hljs-number">10</span><br><span class="hljs-attr">notification:</span><br>  <span class="hljs-attr">webhook_job_max_retry:</span> <span class="hljs-number">10</span><br><span class="hljs-attr">chart:</span><br>  <span class="hljs-attr">absolute_url:</span> <span class="hljs-string">disabled</span><br><span class="hljs-attr">log:</span><br>  <span class="hljs-attr">level:</span> <span class="hljs-string">info</span><br>  <span class="hljs-attr">local:</span><br>    <span class="hljs-attr">rotate_count:</span> <span class="hljs-number">50</span><br>    <span class="hljs-attr">rotate_size:</span> <span class="hljs-string">200M</span><br>    <span class="hljs-attr">location:</span> <span class="hljs-string">/var/log/harbor</span><br><span class="hljs-attr">_version:</span> <span class="hljs-number">2.5</span><span class="hljs-number">.0</span><br><span class="hljs-comment">## 配置外部数据库</span><br><span class="hljs-attr">external_database:</span><br>  <span class="hljs-attr">harbor:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.88</span><span class="hljs-number">.131</span>  <span class="hljs-comment"># 数据库主机地址</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5432</span>  <span class="hljs-comment"># 数据库端口</span><br>    <span class="hljs-attr">db_name:</span> <span class="hljs-string">registry</span>  <span class="hljs-comment"># 数据库名称</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">postgres</span>  <span class="hljs-comment"># 连接该数据库的用户名</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>  <span class="hljs-comment"># 连接数据库的密码</span><br>    <span class="hljs-attr">ssl_mode:</span> <span class="hljs-string">disable</span><br>    <span class="hljs-attr">max_idle_conns:</span> <span class="hljs-number">2</span><br>    <span class="hljs-attr">max_open_conns:</span> <span class="hljs-number">0</span><br>  <span class="hljs-attr">notary_signer:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.88</span><span class="hljs-number">.131</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5432</span><br>    <span class="hljs-attr">db_name:</span> <span class="hljs-string">notary_signer</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">postgres</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">ssl_mode:</span> <span class="hljs-string">disable</span><br>  <span class="hljs-attr">notary_server:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.88</span><span class="hljs-number">.131</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5432</span><br>    <span class="hljs-attr">db_name:</span> <span class="hljs-string">notary_server</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">postgres</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">ssl_mode:</span> <span class="hljs-string">disable</span><br><span class="hljs-comment"># 配置外部Redis 实例</span><br><span class="hljs-attr">external_redis:</span><br>  <span class="hljs-attr">host:</span> <span class="hljs-string">redis:6379</span>  <span class="hljs-comment"># redis服务IP地址和端口号。如果redis是哨兵模式，这里应该是host_sentinel1:port_sentinel1,host_sentinel2:port_sentinel2</span><br>  <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>  <span class="hljs-comment"># 连接外部redis服务的密码</span><br>  <span class="hljs-attr">registry_db_index:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">jobservice_db_index:</span> <span class="hljs-number">2</span>  <span class="hljs-comment"># job服务的数据库索引</span><br>  <span class="hljs-attr">chartmuseum_db_index:</span> <span class="hljs-number">3</span>  <span class="hljs-comment"># chartmeseum插件的redis索引</span><br>  <span class="hljs-attr">trivy_db_index:</span> <span class="hljs-number">5</span>  <span class="hljs-comment"># trivy 扫描器的数据索引</span><br>  <span class="hljs-attr">idle_timeout_seconds:</span> <span class="hljs-number">30</span>  <span class="hljs-comment"># 超时时间</span><br><span class="hljs-attr">proxy:</span><br>  <span class="hljs-attr">http_proxy:</span><br>  <span class="hljs-attr">https_proxy:</span><br>  <span class="hljs-attr">no_proxy:</span><br>  <span class="hljs-attr">components:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">core</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">jobservice</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">trivy</span><br><span class="hljs-comment">## 启用metrics数据采集插件：</span><br><span class="hljs-attr">metric:</span><br>  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9090</span><br>  <span class="hljs-attr">path:</span> <span class="hljs-string">/metrics</span><br><span class="hljs-attr">upload_purging:</span><br>  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">age:</span> <span class="hljs-string">168h</span><br>  <span class="hljs-attr">interval:</span> <span class="hljs-string">24h</span><br>  <span class="hljs-attr">dryrun:</span> <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure>

<h4 id="3-将配置文件注入到组件中"><a href="#3-将配置文件注入到组件中" class="headerlink" title="3) 将配置文件注入到组件中"></a>3) 将配置文件注入到组件中</h4><p><code>./prepare</code>将harbor.yml配置文件的内容注入到各组件的配置文件中。</p>
<p><img src="https://s2.loli.net/2023/06/02/ObWBT8hz7G5KQ1R.png"></p>
<h4 id="4-安装harbor"><a href="#4-安装harbor" class="headerlink" title="4)  安装harbor"></a>4)  安装harbor</h4><p>安装期间会自动导入镜像，执行完成会自动启动Harbor服务。</p>
<figure class="highlight clean"><table><tr><td class="code"><pre><code class="hljs clean">[root@harbor1 harbor]# ./install.sh --<span class="hljs-keyword">with</span>-trivy --<span class="hljs-keyword">with</span>-chartmuseum<br></code></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/06/02/aQBUvLKut1xGXbF.png"><br>-Harbor has been installed and started successfully.- 表示安装成功！</p>
<h4 id="5）查看服务状态"><a href="#5）查看服务状态" class="headerlink" title="5）查看服务状态"></a>5）查看服务状态</h4><p><code>docker-compose ps</code>查看服务状态</p>
<p><img src="https://s2.loli.net/2023/06/02/Ty3kd1J9wbaPSmG.png"></p>
<p>使用实例主机IP+端口在浏览器访问harbor UI</p>
<p>harbor1:<br><img src="https://s2.loli.net/2023/06/02/wye9cEobdNJ8tfz.png"></p>
<p>harbor2:</p>
<p><img src="https://s2.loli.net/2023/06/02/WzE3kgGRt1Qneqr.png"></p>
<p>查看harbor日志：<br><img src="https://s2.loli.net/2023/06/02/7GyXbNWIHqRDtwK.png"></p>
<h1 id="8-服务验证"><a href="#8-服务验证" class="headerlink" title="8 服务验证"></a>8 服务验证</h1><h2 id="8-1-浏览器访问VIP和端口"><a href="#8-1-浏览器访问VIP和端口" class="headerlink" title="8.1 浏览器访问VIP和端口"></a>8.1 浏览器访问VIP和端口</h2><p><a target="_blank" rel="noopener" href="http://192.168.88.111/">http://192.168.88.111</a></p>
<p><img src="https://s2.loli.net/2023/06/02/FKVPfZWb72zv4ON.png"><br><img src="https://s2.loli.net/2023/06/02/zrGFQMiDvJcLU5X.png"></p>
<h2 id="8-2-命令行登录Harbor"><a href="#8-2-命令行登录Harbor" class="headerlink" title="8.2 命令行登录Harbor"></a>8.2 命令行登录Harbor</h2><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">$ docker login http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">88.111</span>:<span class="hljs-number">8121</span> -u admin -p Harbor12345<br></code></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/06/02/Srnlp1vymAKQsC2.png"></p>
<p>出现报错:<br>Error response from daemon: Get <a target="_blank" rel="noopener" href="https://192.168.2.111:8121/v2/">https://192.168.2.111:8121/v2/</a>: http: server gave HTTP response to HTTPS client 在docker配置文件中添加参数：</p>
<figure class="highlight autoit"><table><tr><td class="code"><pre><code class="hljs autoit">cat /etc/docker/daemon.json<br>&#123;<br>  <span class="hljs-string">&quot;exec-opts&quot;</span>: [<br>    <span class="hljs-string">&quot;native.cgroupdriver=systemd&quot;</span><br>  ],<br>  <span class="hljs-string">&quot;insecure-registries&quot;</span>: [<span class="hljs-string">&quot;192.168.88.111:8121&quot;</span>, <span class="hljs-string">&quot;192.168.88.138:8021&quot;</span>, <span class="hljs-string">&quot;192.168.88.139:8021&quot;</span>],<br>  <span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<br>    <span class="hljs-string">&quot;http://hub-mirror.c.163.com&quot;</span>,<br>    <span class="hljs-string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>,<br>    <span class="hljs-string">&quot;https://registry.docker-cn.com&quot;</span><br>  ],<br>  <span class="hljs-string">&quot;log-driver&quot;</span>: <span class="hljs-string">&quot;json-file&quot;</span>,<br>  <span class="hljs-string">&quot;log-opts&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;max-size&quot;</span>: <span class="hljs-string">&quot;100m&quot;</span><br>  &#125;,<br>  <span class="hljs-string">&quot;storage-driver&quot;</span>: <span class="hljs-string">&quot;overlay2&quot;</span><br>&#125;<br><span class="hljs-meta"># 重启docker</span><br>[root<span class="hljs-symbol">@habor</span>-data ~]<span class="hljs-meta"># systemctl daemon-reload</span><br>[root<span class="hljs-symbol">@habor</span>-data ~]<span class="hljs-meta"># systemctl restart docker</span><br><br></code></pre></td></tr></table></figure>


<h2 id="8-3-向Harbor推送镜像"><a href="#8-3-向Harbor推送镜像" class="headerlink" title="8.3 向Harbor推送镜像"></a>8.3 向Harbor推送镜像</h2><figure class="highlight gradle"><table><tr><td class="code"><pre><code class="hljs gradle">[root@habor-data ~]# docker <span class="hljs-keyword">push</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">88.111</span>:<span class="hljs-number">8121</span><span class="hljs-regexp">/library/</span>alpine:<span class="hljs-number">3.16</span><br>The <span class="hljs-keyword">push</span> refers to repository [<span class="hljs-number">192.168</span>.<span class="hljs-number">88.111</span>:<span class="hljs-number">8121</span><span class="hljs-regexp">/library/</span>alpine]<br><span class="hljs-number">5</span>bc340f6d4f5: Pushed <br><span class="hljs-number">3.16</span>: digest: sha256:e28792ec7904bff56f22df296d78cc1188caf347bd824570d0ecf235e4f6e4cd <span class="hljs-keyword">size</span>: <span class="hljs-number">528</span><br><br>[root@habor-data ~]# docker <span class="hljs-keyword">push</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">88.111</span>:<span class="hljs-number">8121</span><span class="hljs-regexp">/library/</span>alpine:<span class="hljs-number">3.16</span><br>The <span class="hljs-keyword">push</span> refers to repository [<span class="hljs-number">192.168</span>.<span class="hljs-number">88.111</span>:<span class="hljs-number">8121</span><span class="hljs-regexp">/library/</span>alpine]<br><span class="hljs-number">5</span>bc340f6d4f5: Pushed <br><span class="hljs-number">3.16</span>: digest: sha256:e28792ec7904bff56f22df296d78cc1188caf347bd824570d0ecf235e4f6e4cd <span class="hljs-keyword">size</span>: <span class="hljs-number">528</span><br></code></pre></td></tr></table></figure>

<p>然后可以在Harbor UI界面查看到镜像已经推送成功！</p>
<p><img src="https://s2.loli.net/2023/06/02/I7PVFRu68Gxe39N.png"></p>

    </div>

    
    
    
        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Ops/" rel="tag"># Ops</a>
              <a href="/tags/k8s/" rel="tag"># k8s</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/02/24/k8s%E4%B8%9A%E5%8A%A1%E5%AE%B9%E5%99%A8%E5%8C%96%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/" rel="prev" title="k8s业务容器化实战案例">
      <i class="fa fa-chevron-left"></i> k8s业务容器化实战案例
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/08/10/minio%E5%AE%89%E8%A3%85/" rel="next" title="minio安装">
      minio安装 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%8E%AF%E5%A2%83%E8%AF%B4%E6%98%8E"><span class="nav-number">1.</span> <span class="nav-text">1 环境说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 架构图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E4%B8%BB%E6%9C%BA%E6%B8%85%E5%8D%95"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 主机清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E6%9C%8D%E5%8A%A1%E7%89%88%E6%9C%AC"><span class="nav-number">1.3.</span> <span class="nav-text">1.3 服务版本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%B8%BB%E6%9C%BA%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">2.</span> <span class="nav-text">2 主机初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E5%AE%89%E8%A3%85docker"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 安装docker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E5%AE%89%E8%A3%85docker-compose"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 安装docker-compose</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E9%85%8D%E7%BD%AE%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 配置内核参数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E4%BD%BF%E7%94%A8NFS%E6%8F%90%E4%BE%9B%E5%A4%96%E9%83%A8%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8"><span class="nav-number">3.</span> <span class="nav-text">3 使用NFS提供外部共享存储</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E9%83%A8%E7%BD%B2NFS%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 部署NFS服务端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E9%83%A8%E7%BD%B2%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 部署客户端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8C%82%E5%9C%A8NFS%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 客户端挂在NFS共享存储</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E9%83%A8%E7%BD%B2Redis%E7%BC%93%E5%AD%98%E6%9C%8D%E5%8A%A1%EF%BC%88%E6%BA%90%E7%A0%81%EF%BC%89"><span class="nav-number">4.</span> <span class="nav-text">4 部署Redis缓存服务（源码）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85%E5%8C%85"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 下载安装包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96%E5%8C%85"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 安装依赖包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91"><span class="nav-number">4.3.</span> <span class="nav-text">4.3 源码编译</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">4.4.</span> <span class="nav-text">4.4 修改配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-%E5%90%AF%E5%8A%A8redis%E6%9C%8D%E5%8A%A1"><span class="nav-number">4.5.</span> <span class="nav-text">4.5 启动redis服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-%E6%9C%8D%E5%8A%A1%E9%AA%8C%E8%AF%81"><span class="nav-number">4.6.</span> <span class="nav-text">4.6 服务验证</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E9%83%A8%E7%BD%B2PostgreSQL%E5%A4%96%E9%83%A8%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1%EF%BC%88%E6%BA%90%E7%A0%81%EF%BC%89"><span class="nav-number">5.</span> <span class="nav-text">5 部署PostgreSQL外部存储服务（源码）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E6%96%B0%E5%BB%BApostgres%E7%94%A8%E6%88%B7"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 新建postgres用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96%E5%8C%85"><span class="nav-number">5.2.</span> <span class="nav-text">5.2 安装依赖包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-%E4%B8%8B%E8%BD%BD%E8%A7%A3%E5%8E%8B%E6%BA%90%E7%A0%81%E5%8C%85"><span class="nav-number">5.3.</span> <span class="nav-text">5.3 下载解压源码包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="nav-number">5.4.</span> <span class="nav-text">5.4 编译安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-5-%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E7%9B%AE%E5%BD%95"><span class="nav-number">5.5.</span> <span class="nav-text">5.5 创建数据目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-6-%E8%AE%BE%E7%BD%AEpostgres%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-number">5.6.</span> <span class="nav-text">5.6 设置postgres环境变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-7-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">5.7.</span> <span class="nav-text">5.7 初始化数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-8-%E5%90%AF%E5%8A%A8PostgreSQL"><span class="nav-number">5.8.</span> <span class="nav-text">5.8 启动PostgreSQL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-9-%E8%AE%BE%E7%BD%AE%EF%BC%88%E4%BF%AE%E6%94%B9%EF%BC%89Postgresql%E5%AF%86%E7%A0%81"><span class="nav-number">5.9.</span> <span class="nav-text">5.9 设置（修改）Postgresql密码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-10-%E8%AE%BE%E7%BD%AE%E5%8F%AF%E8%BF%9C%E7%A8%8B%E7%99%BB%E5%BD%95PostgreSQL"><span class="nav-number">5.10.</span> <span class="nav-text">5.10  设置可远程登录PostgreSQL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-11-%E9%87%8D%E5%90%AFPostgreSQL"><span class="nav-number">5.11.</span> <span class="nav-text">5.11 重启PostgreSQL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-12-%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">5.12.</span> <span class="nav-text">5.12 创建数据库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%AE%BE%E7%BD%AE%EF%BC%88Nginx-Keepalived%EF%BC%89"><span class="nav-number">6.</span> <span class="nav-text">6 负载均衡设置（Nginx + Keepalived）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E5%AE%89%E8%A3%85nginx%E5%92%8Ckeepalived"><span class="nav-number">6.1.</span> <span class="nav-text">6.1 安装nginx和keepalived</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-%E4%BF%AE%E6%94%B9nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">6.2.</span> <span class="nav-text">6.2 修改nginx配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-%E4%BF%AE%E6%94%B9keepalived-%E9%85%8D%E7%BD%AE"><span class="nav-number">6.3.</span> <span class="nav-text">6.3 修改keepalived 配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E4%B8%BB%E8%8A%82%E7%82%B9%EF%BC%88harbor1%EF%BC%89"><span class="nav-number">6.3.1.</span> <span class="nav-text">1)主节点（harbor1）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%A4%87%E8%8A%82%E7%82%B9%EF%BC%88harbo2%EF%BC%89"><span class="nav-number">6.3.2.</span> <span class="nav-text">2)备节点（harbo2）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-%E7%BC%96%E5%86%99%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5%E8%84%9A%E6%9C%AC"><span class="nav-number">6.4.</span> <span class="nav-text">6.4 编写健康检查脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-5-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="nav-number">6.5.</span> <span class="nav-text">6.5 启动服务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%EF%BC%89%E5%90%AF%E5%8A%A8nginx%E6%9C%8D%E5%8A%A1"><span class="nav-number">6.5.1.</span> <span class="nav-text">1）启动nginx服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%EF%BC%89%E5%90%AF%E5%8A%A8keepalived%E6%9C%8D%E5%8A%A1"><span class="nav-number">6.5.2.</span> <span class="nav-text">2）启动keepalived服务</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-6-%E6%9F%A5%E7%9C%8BVIP"><span class="nav-number">6.6.</span> <span class="nav-text">6.6 查看VIP</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E9%83%A8%E7%BD%B2harbor%E5%AE%9E%E4%BE%8B"><span class="nav-number">7.</span> <span class="nav-text">7 部署harbor实例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-%E5%9C%A8harbor1-%E4%B8%BB%E6%9C%BA%E4%B8%8A%E9%83%A8%E7%BD%B2harbor%E6%9C%8D%E5%8A%A1"><span class="nav-number">7.1.</span> <span class="nav-text">7.1 在harbor1 主机上部署harbor服务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%EF%BC%89%E4%B8%8B%E8%BD%BD%E8%A7%A3%E5%8E%8B%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85%E5%8C%85"><span class="nav-number">7.1.1.</span> <span class="nav-text">1 ）下载解压离线安装包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%EF%BC%89%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">7.1.2.</span> <span class="nav-text">2）修改配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E5%B0%86%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%B3%A8%E5%85%A5%E5%88%B0%E7%BB%84%E4%BB%B6%E4%B8%AD"><span class="nav-number">7.1.3.</span> <span class="nav-text">3) 将配置文件注入到组件中</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E5%AE%89%E8%A3%85harbor"><span class="nav-number">7.1.4.</span> <span class="nav-text">4)  安装harbor</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%EF%BC%89%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1%E7%8A%B6%E6%80%81"><span class="nav-number">7.1.5.</span> <span class="nav-text">5）查看服务状态</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-%E6%9C%8D%E5%8A%A1%E9%AA%8C%E8%AF%81"><span class="nav-number"></span> <span class="nav-text">8 服务验证</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1-%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AEVIP%E5%92%8C%E7%AB%AF%E5%8F%A3"><span class="nav-number">1.</span> <span class="nav-text">8.1 浏览器访问VIP和端口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2-%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%99%BB%E5%BD%95Harbor"><span class="nav-number">2.</span> <span class="nav-text">8.2 命令行登录Harbor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-3-%E5%90%91Harbor%E6%8E%A8%E9%80%81%E9%95%9C%E5%83%8F"><span class="nav-number">3.</span> <span class="nav-text">8.3 向Harbor推送镜像</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="QinTianJun"
      src="/images/logo.jpeg">
  <p class="site-author-name" itemprop="name">QinTianJun</p>
  <div class="site-description" itemprop="description">一个菜鸟的成长之路</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">22</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/qtj1215" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;qtj1215" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:freedom1215@foxmail.com" title="E-Mail → mailto:freedom1215@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.qintianjun.top/atom.xml" title="RSS → https:&#x2F;&#x2F;www.qintianjun.top&#x2F;atom.xml"><i class="fas fa-rss fa-fw"></i></a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">QinTianJun</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
