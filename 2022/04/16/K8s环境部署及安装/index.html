<!DOCTYPE html>
<html lang="zh-CN,en,default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.qintianjun.top","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="K8s环境部署及安装，暂时采用kubeadm方式安装，后续考虑二进制部署">
<meta property="og:type" content="article">
<meta property="og:title" content="K8s环境部署及安装（kubeadm方式）">
<meta property="og:url" content="http://www.qintianjun.top/2022/04/16/K8s%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E5%8F%8A%E5%AE%89%E8%A3%85/index.html">
<meta property="og:site_name" content="Freedom_ATX&#39;s Blog">
<meta property="og:description" content="K8s环境部署及安装，暂时采用kubeadm方式安装，后续考虑二进制部署">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/sx38BlWQHg9IAUF.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/JVuMpinschfTCbv.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/ifZ1cGv9zerowU2.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/WlgFb3Lid1D4u6f.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/y92eYDqJnOtC5MU.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/FHrskaxJXRAKGzh.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/3NGOCavI8rJXykd.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/KN8UadPh7ZE9LXM.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/hR8ZbmLFQXW6TxU.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/o82n3MCxIRJ1wGv.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/Ju7hcDqXTnt8a5C.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/tgCSsnUjLXdKcHY.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/Zs2F6M7rUu8aDmz.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/16/X92arLoTweYKJPN.png">
<meta property="article:published_time" content="2022-04-16T14:57:11.000Z">
<meta property="article:modified_time" content="2023-02-24T08:07:26.823Z">
<meta property="article:author" content="QinTianJun">
<meta property="article:tag" content="Ops">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/04/16/sx38BlWQHg9IAUF.png">

<link rel="canonical" href="http://www.qintianjun.top/2022/04/16/K8s%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E5%8F%8A%E5%AE%89%E8%A3%85/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>K8s环境部署及安装（kubeadm方式） | Freedom_ATX's Blog</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b8f33cffae5a7adb95d2bdb812879d09";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Freedom_ATX's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Freedom_ATX's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.qintianjun.top/2022/04/16/K8s%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E5%8F%8A%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/logo.jpeg">
      <meta itemprop="name" content="QinTianJun">
      <meta itemprop="description" content="一个菜鸟的成长之路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Freedom_ATX's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          K8s环境部署及安装（kubeadm方式）
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-16 22:57:11" itemprop="dateCreated datePublished" datetime="2022-04-16T22:57:11+08:00">2022-04-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-24 16:07:26" itemprop="dateModified" datetime="2023-02-24T16:07:26+08:00">2023-02-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ops/" itemprop="url" rel="index"><span itemprop="name">Ops</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ops/Cloud/" itemprop="url" rel="index"><span itemprop="name">Cloud</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="K8s环境部署及安装（kubeadm方式）"><a href="#K8s环境部署及安装（kubeadm方式）" class="headerlink" title="K8s环境部署及安装（kubeadm方式）"></a>K8s环境部署及安装（kubeadm方式）</h1><h2 id="1-CentOS-安装及初始化"><a href="#1-CentOS-安装及初始化" class="headerlink" title="1 CentOS 安装及初始化"></a>1 CentOS 安装及初始化</h2><h3 id="1-1-切换阿里源"><a href="#1-1-切换阿里源" class="headerlink" title="1.1 切换阿里源"></a>1.1 切换阿里源</h3><p>以CentOS-7.9-minimal为例：</p>
<ol>
<li>备份</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>安装wget</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">yum install -y wget<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>下载新的 CentOS-Base.repo 到 &#x2F;etc&#x2F;yum.repos.d&#x2F;</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo<br></code></pre></td></tr></table></figure>

<ol start="4">
<li>运行 yum makecache 生成缓存</li>
<li>其他</li>
</ol>
<p>​	非阿里云ECS用户会出现 Couldn’t resolve host ‘mirrors.cloud.aliyuncs.com’ 信息，不影响使用。用户也可自行修改相	关配置: eg:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">sed -i -e &#x27;/mirrors.cloud.aliyuncs.com/d&#x27; -e &#x27;/mirrors.aliyuncs.com/d&#x27; /etc/yum.repos.d/CentOS-Base.repo<br></code></pre></td></tr></table></figure>

<h3 id="1-2-切换epel源"><a href="#1-2-切换epel源" class="headerlink" title="1.2 切换epel源"></a>1.2 切换epel源</h3><ol>
<li>备份(如有配置其他epel源)</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">mv /etc/yum.repos.d/epel.repo /etc/yum.repos.d/epel.repo.backup<br>mv /etc/yum.repos.d/epel-testing.repo /etc/yum.repos.d/epel-testing.repo.backup<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>下载新repo 到&#x2F;etc&#x2F;yum.repos.d&#x2F;</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo<br></code></pre></td></tr></table></figure>

<h3 id="1-3-安装常用命令"><a href="#1-3-安装常用命令" class="headerlink" title="1.3 安装常用命令"></a>1.3 安装常用命令</h3><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">yum install -y vim wget pcre pcre-devel zlib zlib-devel openssl openssl-devel iproute net-tools iotop gcc<br></code></pre></td></tr></table></figure>

<h3 id="1-4-安装docker-ce"><a href="#1-4-安装docker-ce" class="headerlink" title="1.4 安装docker-ce"></a>1.4 安装docker-ce</h3><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo # docker阿里源<br>yum install -y docker-ce docker-ce-cli containerd.io<br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动并设为开机自启</span><br>systemctl start docker<br>systemctl enble docker<br></code></pre></td></tr></table></figure>



<h3 id="1-5-k8s高可用集群环境规划信息："><a href="#1-5-k8s高可用集群环境规划信息：" class="headerlink" title="1.5 k8s高可用集群环境规划信息："></a>1.5 k8s高可用集群环境规划信息：</h3><p>按照实际环境需求，进行规划与部署响应单master或者多master高可用k8s运行环境</p>
<h4 id="1-5-1-单master环境"><a href="#1-5-1-单master环境" class="headerlink" title="1.5.1 单master环境"></a>1.5.1 单master环境</h4><p><img src="https://s2.loli.net/2022/04/16/sx38BlWQHg9IAUF.png" alt="image-20220412142415985"></p>
<p> 个人电脑配置不高的，可以部署一个最小化的环境</p>
<ul>
<li>master节点一台：1CPU，2G内存，50G硬盘</li>
<li>etcd1台，1CPU，1G内存，50G硬盘</li>
<li>node节点两台：2CPU，2G内存，50G硬盘</li>
</ul>
<h4 id="1-5-2-多master环境"><a href="#1-5-2-多master环境" class="headerlink" title="1.5.2 多master环境"></a>1.5.2 多master环境</h4><p><img src="https://s2.loli.net/2022/04/16/JVuMpinschfTCbv.png" alt="image-20220412104337524"></p>
<table>
<thead>
<tr>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>ansible * 2</td>
<td>k8s集群部署服务器，可以和其他服务器混用</td>
</tr>
<tr>
<td>k8s master * 3</td>
<td>k8s控制端，通过一个vip做主备做高可用</td>
</tr>
<tr>
<td>harbor * 2</td>
<td>高可用镜像服务器</td>
</tr>
<tr>
<td>etcd * 3</td>
<td>保存k8s集群数据的服务器</td>
</tr>
<tr>
<td>haproxy * 2</td>
<td>高可用etcd代理服务器</td>
</tr>
<tr>
<td>node节点 * (2 - N)</td>
<td>真正运行容器的服务器端，高可用环境至少两台</td>
</tr>
</tbody></table>
<h2 id="2-haproxy及-keepalived-高可用集群安装"><a href="#2-haproxy及-keepalived-高可用集群安装" class="headerlink" title="2 haproxy及 keepalived 高可用集群安装"></a>2 haproxy及 keepalived 高可用集群安装</h2><p>在生产环境中 haproxy 广泛用于四层和七层的反向负载，haproxy 则通过 VRRP 技术实现虚拟 IP 高可用从而实现 haproxy 的高可用，本文将侧重于介绍 keepalived 方面的知识及相关配置介绍，haproxy 只用于测试 web 代理，具体如下：</p>
<h3 id="2-1-安装haproxy"><a href="#2-1-安装haproxy" class="headerlink" title="2.1 安装haproxy"></a>2.1 安装haproxy</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@ha1 soft]<span class="hljs-comment"># wget https://www.haproxy.org/download/2.5/src/haproxy-2.5.5.tar.gz</span><br>[root@ha1 soft]<span class="hljs-comment"># less INSTALL # 安装相关说明信息</span><br>[root@ha1 soft]<span class="hljs-comment"># make TARGET=linux-glibc USE_PCRE=1 USE_OPENSSL=1 USE_ZLIB=1  PREFIX=/usr/local/haproxy</span><br>[root@ha1 soft]<span class="hljs-comment"># make install PREFIX=/usr/local/haproxy</span><br></code></pre></td></tr></table></figure>

<p>创建配置文件目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@ha1 haproxy-2.5.5]<span class="hljs-comment"># mkdir -p /usr/local/haproxy/conf</span><br>[root@ha1 haproxy-2.5.5]<span class="hljs-comment"># mkdir -p /etc/haproxy/</span><br></code></pre></td></tr></table></figure>

<p>从配置文件模版复制配置文件并添加配置文件软连接</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@ha1 haproxy-2.5.5]<span class="hljs-comment"># cp examples/option-http_proxy.cfg /usr/local/haproxy/conf/haproxy.cfg</span><br>[root@ha1 haproxy-2.5.5]<span class="hljs-comment"># ln -s /usr/local/haproxy/conf/haproxy.cfg /etc/haproxy/haproxy.cfg</span><br>[root@ha1 haproxy-2.5.5]<span class="hljs-comment"># ln -s /usr/local/haproxy/sbin/haproxy /usr/sbin/haproxy</span><br></code></pre></td></tr></table></figure>

<p>拷贝错误页面，并添加目录软连接（HTTP 模式选配）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@ha1 haproxy-2.5.5]<span class="hljs-comment"># cp -r examples/errorfiles /usr/local/haproxy/</span><br>[root@ha1 haproxy-2.5.5]<span class="hljs-comment"># ln -s /usr/local/haproxy/errorfiles /etc/haproxy/errorfiles</span><br></code></pre></td></tr></table></figure>

<p>拷贝开机启动文件，并赋予可执行权限</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@ha1 haproxy-2.5.5]<span class="hljs-comment"># cp examples/haproxy.init /etc/init.d/haproxy</span><br>[root@ha1 haproxy-2.5.5]<span class="hljs-comment"># chmod +x /etc/init.d/haproxy</span><br></code></pre></td></tr></table></figure>

<p>添加 haproxy 用户组和用户, 创建 chroot 运行的路径</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@localhost haproxy]<span class="hljs-comment"># groupadd haproxy</span><br>[root@localhost haproxy]<span class="hljs-comment"># useradd -g haproxy haproxy</span><br>[root@localhost haproxy]<span class="hljs-comment"># mkdir /usr/share/haproxy</span><br></code></pre></td></tr></table></figure>

<p>设置 HAProxy 开机启动 (可选)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@ha1 haproxy-2.5.5]<span class="hljs-comment"># chkconfig --add haproxy</span><br>[root@ha1 haproxy-2.5.5]<span class="hljs-comment"># chkconfig haproxy on</span><br></code></pre></td></tr></table></figure>

<p>编辑haproxy.cfg内容：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@ha1 init.d]<span class="hljs-comment"># cat /etc/haproxy/haproxy.cfg</span><br>global<br><span class="hljs-built_in">chroot</span> /usr/local/haproxy<br><span class="hljs-comment">#stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin</span><br>user haproxy<br>group haproxy<br>daemon<br><span class="hljs-comment">#nbproc 1</span><br>pidfile /var/run/haproxy.pid<br><span class="hljs-built_in">log</span> 127.0.0.1 local3 info<br><br>defaults<br>option http-keep-alive<br>option  forwardfor<br>mode http<br><span class="hljs-built_in">timeout</span> connect 300000ms<br><span class="hljs-built_in">timeout</span> client  300000ms<br><span class="hljs-built_in">timeout</span> server  300000ms<br><br>listen stats<br> mode http<br> <span class="hljs-built_in">bind</span> 192.168.200.16:9999 <span class="hljs-comment"># 与keepalive的vip地址一致</span><br> stats <span class="hljs-built_in">enable</span><br> <span class="hljs-built_in">log</span> global<br> stats uri     /haproxy-status<br> stats auth    haadmin:123456<br><br>listen  web_port<br> <span class="hljs-built_in">bind</span> 0.0.0.0:80<br> mode http<br> <span class="hljs-built_in">log</span> global<br> balance roundrobin<br> server web1  192.168.68.152:8080  check inter 3000 fall 2 rise 5<br> server web2  192.168.68.153:8080  check inter 3000 fall 2 rise 5<br></code></pre></td></tr></table></figure>

<p>此时curl对应vip地址有返回（后端服务还没起，503正常）</p>
<p><img src="https://s2.loli.net/2022/04/16/ifZ1cGv9zerowU2.png" alt="image-20220412120532559"></p>
<blockquote>
<p>补充haproxy配置说明：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><code class="hljs ini"><span class="hljs-comment">##</span><br><span class="hljs-comment">## Haproxy 配置文件</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">###################################################################################################</span><br><br><span class="hljs-comment">## global配置中的参数为进程级别的参数，通常与其运行的操作系统有关</span><br>global<br> log 127.0.0.1    local0    info <span class="hljs-comment">## 定义全局的syslog服务器，最多可以定义2个</span><br> <span class="hljs-comment">### local0是日志设备，对应于/etc/rsyslog.conf中的配置，默认回收info的日志级别</span><br> <span class="hljs-comment">#log 127.0.0.1    local1 info</span><br> chroot /usr/share/haproxy    <span class="hljs-comment">## 修改HAProxy的工作目录至指定的目录并在放弃权限之前执行</span><br>                             <span class="hljs-comment">### chroot() 操作，可以提升 haproxy 的安全级别</span><br> group    haproxy    <span class="hljs-comment">## 同gid，不过这里为指定的用户组名</span><br> user    haproxy    <span class="hljs-comment">## 同uid，但这里使用的为用户名</span><br> daemon    <span class="hljs-comment">## 设置haproxy后台守护进程形式运行</span><br> nbproc    1    <span class="hljs-comment">## 指定启动的haproxy进程个数，</span><br>             <span class="hljs-comment">### 只能用于守护进程模式的haproxy；默认为止启动1个进程，</span><br>             <span class="hljs-comment">### 一般只在单进程仅能打开少数文件描述符的场中中才使用多进程模式</span><br> maxconn 4096    <span class="hljs-comment">## 设定每个haproxy进程所接受的最大并发连接数，</span><br>                 <span class="hljs-comment">### 其等同于命令行选项&quot;-n&quot;，&quot;ulimit-n&quot;自动计算的结果正式参照从参数设定的</span><br> <span class="hljs-comment"># pidfile    /var/run/haproxy.pid    ## 进程文件（默认路径 /var/run/haproxy.pid）</span><br> node    edu-haproxy-01    <span class="hljs-comment">## 定义当前节点的名称，用于HA场景中多haproxy进程共享同一个IP地址时</span><br> description    edu-haproxy-01    <span class="hljs-comment">## 当前实例的描述信息</span><br><br><span class="hljs-comment">## defaults：用于为所有其他配置段提供默认参数，这默认配置参数可由下一个&quot;defaults&quot;所重新设定</span><br>defaults<br> log    global    <span class="hljs-comment">## 继承global中log的定义</span><br> mode    http    <span class="hljs-comment">## mode:所处理的模式 (tcp:四层 , http:七层 , health:状态检查,只会返回OK) </span><br> <span class="hljs-comment">### tcp: 实例运行于纯tcp模式，在客户端和服务器端之间将建立一个全双工的连接，</span><br> <span class="hljs-comment">#### 且不会对7层报文做任何类型的检查，此为默认模式</span><br> <span class="hljs-comment">### http:实例运行于http模式，客户端请求在转发至后端服务器之前将被深度分析，</span><br> <span class="hljs-comment">#### 所有不与RFC模式兼容的请求都会被拒绝</span><br> <span class="hljs-comment">### health：实例运行于health模式，其对入站请求仅响应“OK”信息并关闭连接，</span><br> <span class="hljs-comment">#### 且不会记录任何日志信息 ，此模式将用于相应外部组件的监控状态检测请求</span><br> option    httplog<br> retries    3<br> option redispatch    <span class="hljs-comment">## serverId对应的服务器挂掉后,强制定向到其他健康的服务器</span><br> maxconn    2000    <span class="hljs-comment">## 前端的最大并发连接数（默认为2000）</span><br> <span class="hljs-comment">### 其不能用于backend区段，对于大型站点来说，可以尽可能提高此值以便让haproxy管理连接队列，</span><br> <span class="hljs-comment">### 从而避免无法应答用户请求。当然，此最大值不能超过“global”段中的定义。</span><br> <span class="hljs-comment">### 此外，需要留心的是，haproxy会为每个连接维持两个缓冲，每个缓存的大小为8KB，</span><br> <span class="hljs-comment">### 再加上其他的数据，每个连接将大约占用17KB的RAM空间，这意味着经过适当优化后 ，</span><br> <span class="hljs-comment">### 有着1GB的可用RAM空间时将维护40000-50000并发连接。</span><br> <span class="hljs-comment">### 如果指定了一个过大值，极端场景中，其最终所占据的空间可能会超过当前主机的可用内存，</span><br> <span class="hljs-comment">### 这可能会带来意想不到的结果，因此，将其设定一个可接受值放为明智绝对，其默认为2000</span><br> timeout connect    5000ms    <span class="hljs-comment">## 连接超时(默认是毫秒,单位可以设置us,ms,s,m,h,d)</span><br> timeout client    50000ms    <span class="hljs-comment">## 客户端超时</span><br> timeout server    50000ms    <span class="hljs-comment">## 服务器超时</span><br><br><span class="hljs-comment">## HAProxy的状态信息统计页面</span><br>listen admin_stats <br> bind    :48800  <span class="hljs-comment">## 绑定端口</span><br> stats    uri /admin-status    <span class="hljs-comment">## 统计页面URI</span><br> stats    auth admin:admin    <span class="hljs-comment">## 设置统计页面认证的用户和密码，如果要设置多个，另起一行写入即可</span><br> mode    http<br> option    httplog    <span class="hljs-comment">## 启用日志记录HTTP请求</span><br><br><span class="hljs-comment">## listen: 用于定义通过关联“前端”和“后端”一个完整的代理，通常只对TCP流量有用</span><br>listen    mycat_servers<br> bind    :3307  <span class="hljs-comment">## 绑定端口 ---------------------------------------------------------------------这里一定要注意，在测试连接的时候，端口指定3307</span><br> mode    tcp<br> option    tcplog    <span class="hljs-comment">## 记录TCP请求日志</span><br> option    tcpka    <span class="hljs-comment">## 是否允许向server和client发送keepalive</span><br> option    httpchk OPTIONS * HTTP/1.1\r\nHost:\ www    <span class="hljs-comment">## 后端服务状态检测</span><br> <span class="hljs-comment">### 向后端服务器的48700端口（端口值在后端服务器上通过xinetd配置）发送 OPTIONS 请求</span><br> <span class="hljs-comment">### (原理请参考HTTP协议) ，HAProxy会根据返回内容来判断后端服务是否可用.</span><br> <span class="hljs-comment">### 2xx 和 3xx 的响应码表示健康状态，其他响应码或无响应表示服务器故障。</span><br> balance    roundrobin    <span class="hljs-comment">## 定义负载均衡算法，可用于&quot;defaults&quot;、&quot;listen&quot;和&quot;backend&quot;中,默认为轮询方式</span><br> server    mycat_01 192.168.9.169:8066 check port 48700 inter 2000ms rise 2 fall 3 weight 10  ------------------------------------------------第一台mycat<br> server    mycat_02 192.168.9.170:8066 check port 48700 inter 2000ms rise 2 fall 3 weight 10  ------------------------------------------------第二台mycat<br> <span class="hljs-comment">## 格式：server &lt;name&gt; &lt;address&gt;[:[port]] [param*]</span><br> <span class="hljs-comment">### serser 在后端声明一个server，只能用于listen和backend区段。</span><br> <span class="hljs-comment">### &lt;name&gt;为此服务器指定的内部名称，其将会出现在日志及警告信息中</span><br> <span class="hljs-comment">### &lt;address&gt;此服务器的IPv4地址，也支持使用可解析的主机名，但要在启动时需要解析主机名至响应的IPV4地址</span><br> <span class="hljs-comment">### [:[port]]指定将客户端连接请求发往此服务器时的目标端口，此为可选项</span><br> <span class="hljs-comment">### [param*]为此server设定的一系列参数，均为可选项，参数比较多，下面仅说明几个常用的参数：</span><br> <span class="hljs-comment">#### weight:权重，默认为1，最大值为256，0表示不参与负载均衡</span><br> <span class="hljs-comment">#### backup:设定为备用服务器，仅在负载均衡场景中的其他server均不可以启用此server</span><br> <span class="hljs-comment">#### check:启动对此server执行监控状态检查，其可以借助于额外的其他参数完成更精细的设定</span><br> <span class="hljs-comment">#### inter:设定监控状态检查的时间间隔，单位为毫秒，默认为2000，</span><br> <span class="hljs-comment">##### 也可以使用fastinter和downinter来根据服务器端专题优化此事件延迟</span><br> <span class="hljs-comment">#### rise:设置server从离线状态转换至正常状态需要检查的次数（不设置的情况下，默认值为2）</span><br> <span class="hljs-comment">#### fall:设置server从正常状态转换至离线状态需要检查的次数（不设置的情况下，默认值为3）</span><br> <span class="hljs-comment">#### cookie:为指定server设定cookie值，此处指定的值将会在请求入站时被检查，</span><br> <span class="hljs-comment">##### 第一次为此值挑选的server将会被后续的请求所选中，其目的在于实现持久连接的功能</span><br> <span class="hljs-comment">#### maxconn:指定此服务器接受的最大并发连接数，如果发往此服务器的连接数目高于此处指定的值，</span><br> <span class="hljs-comment">#####其将被放置于请求队列，以等待其他连接被释放</span><br></code></pre></td></tr></table></figure>


</blockquote>
<h3 id="2-2-安装keepalived"><a href="#2-2-安装keepalived" class="headerlink" title="2.2 安装keepalived"></a>2.2 安装keepalived</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@ha1 soft]<span class="hljs-comment"># wget https://www.keepalived.org/software/keepalived-2.2.7.tar.gz</span><br>[root@ha1 soft]<span class="hljs-comment"># tar -xf keepalived-2.2.7.tar.gz &amp;&amp; cd keepalived-2.2.7</span><br>[root@ha1 soft]<span class="hljs-comment"># /configure --prefix=/usr/local/keepalived --sysconf=/etc</span><br>[root@ha1 soft]<span class="hljs-comment"># make &amp;&amp; make install</span><br></code></pre></td></tr></table></figure>

<p>从源码包拷贝服务配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@ha1 soft]<span class="hljs-comment"># cp ./keepalived/etc/init.d/keepalived /etc/init.d/</span><br>[root@ha1 soft]<span class="hljs-comment"># systemctl daemon-reload</span><br>[root@ha1 soft]<span class="hljs-comment"># systemctl start keepalived.service # 起进程前先修				改/etc/keepalive/keepalive.config</span><br></code></pre></td></tr></table></figure>

<p>修改ha1,ha2对应keepalived配置文件,实现keepalived双机主备高可用:</p>
<p><img src="https://s2.loli.net/2022/04/16/WlgFb3Lid1D4u6f.png" alt="keepalived双机主备"></p>
<p>此处将ha2设为master,ha1设为backup:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@ha1 keepalived]<span class="hljs-comment"># cat keepalived.conf</span><br>global_defs &#123;<br>   router_id keepalive_192.168.1.16<br>&#125;<br>vrrp_script check_nginx_alive&#123;<br>   script <span class="hljs-string">&quot;/etc/keepalived/check_nginx_alive_or_not.sh&quot;</span><br>   interval 2<br>   weight 10<br>&#125;<br>vrrp_instance VI_1 &#123;<br>    state BACKUP <span class="hljs-comment"># 注意!此处state的名称并不能决定对应主从身份，主从身份是由priority决定的!</span><br>    interface ens33<br>    virtual_router_id 51<br>    priority 50<br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 1111<br>    &#125;<br>    virtual_ipaddress &#123;<br>        192.168.200.16<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@ha2 keepalived]<span class="hljs-comment"># cat keepalived.conf</span><br>global_defs &#123;<br>   router_id keepalive_192.168.68.149<br>&#125;<br>vrrp_script check_nginx_alive&#123;<br>   script <span class="hljs-string">&quot;/etc/keepalived/check_nginx_alive_or_not.sh&quot;</span><br>   interval 2<br>   weight 10<br>&#125;<br>vrrp_instance VI_1 &#123;<br>    state MASTER<br>    interface ens33<br>    virtual_router_id 51<br>    priority 100  <span class="hljs-comment"># ha2的priority值比ha1高，决定了它会被选为master</span><br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 1111<br>    &#125;<br>    virtual_ipaddress &#123;<br>        192.168.200.16<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>默认情况下，如果ha1&#x2F;2中启动一个以后，另外一个服务无法起动，可能是因为linux默认不允许IP地址绑定非本机的端口，需要修改对应内核参数, 修改<code>/etc/sysctl.conf</code>：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">net.ipv4.ip_forward</span> = <span class="hljs-number">1</span><br><span class="hljs-attr">net.ipv4.ip_nonlocal_bind</span> = <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<p>输入<code>sysctl -p</code> 使新内核参数生效</p>
</blockquote>
<p>此时起进程查看对应网卡状态</p>
<p><img src="https://s2.loli.net/2022/04/16/y92eYDqJnOtC5MU.png" alt="image-20220411214148201"></p>
<p><img src="https://s2.loli.net/2022/04/16/FHrskaxJXRAKGzh.png" alt="image-20220411214225989"></p>
<p>此时，在不间断ping该地址时，将ha2主机挂起，keepalived会将vip飘到ha1上，ping不会中断：</p>
<p><img src="https://s2.loli.net/2022/04/16/3NGOCavI8rJXykd.png" alt="image-20220411214441361"></p>
<p>说明keepalive服务生效</p>
<h2 id="3-部署harbor仓库"><a href="#3-部署harbor仓库" class="headerlink" title="3 部署harbor仓库"></a>3 部署harbor仓库</h2><h3 id="3-1-安装docker-ce"><a href="#3-1-安装docker-ce" class="headerlink" title="3.1 安装docker-ce"></a>3.1 安装docker-ce</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br>yum install -y docker-ce<br></code></pre></td></tr></table></figure>

<p>harbor软硬件要求：</p>
<h3 id="Hardware"><a href="#Hardware" class="headerlink" title="Hardware"></a>Hardware</h3><p>The following table lists the minimum and recommended hardware configurations for deploying Harbor.</p>
<table>
<thead>
<tr>
<th align="left">Resource</th>
<th align="left">Minimum</th>
<th align="left">Recommended</th>
</tr>
</thead>
<tbody><tr>
<td align="left">CPU</td>
<td align="left">2 CPU</td>
<td align="left">4 CPU</td>
</tr>
<tr>
<td align="left">Mem</td>
<td align="left">4 GB</td>
<td align="left">8 GB</td>
</tr>
<tr>
<td align="left">Disk</td>
<td align="left">40 GB</td>
<td align="left">160 GB</td>
</tr>
</tbody></table>
<h3 id="Software"><a href="#Software" class="headerlink" title="Software"></a>Software</h3><p>The following table lists the software versions that must be installed on the target host.</p>
<table>
<thead>
<tr>
<th align="left">Software</th>
<th align="left">Version</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Docker engine</td>
<td align="left">Version 17.06.0-ce+ or higher</td>
<td align="left">For installation instructions, see <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/installation/">Docker Engine documentation</a></td>
</tr>
<tr>
<td align="left">Docker Compose</td>
<td align="left">Version 1.18.0 or higher</td>
<td align="left">For installation instructions, see <a target="_blank" rel="noopener" href="https://docs.docker.com/compose/install/">Docker Compose documentation</a></td>
</tr>
<tr>
<td align="left">Openssl</td>
<td align="left">Latest is preferred</td>
<td align="left">Used to generate certificate and keys for Harbor</td>
</tr>
</tbody></table>
<h3 id="3-2-下载安装harbor"><a href="#3-2-下载安装harbor" class="headerlink" title="3.2 下载安装harbor"></a>3.2 下载安装harbor</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 推荐使用离线包方式安装</span><br>wget https://github.com/goharbor/harbor/releases/download/v2.5.0/harbor-offline-installer-v2.5.0.tgz<br>tar -xf harbor-offline-installer-v2.5.0.tgz<br><span class="hljs-built_in">cd</span> harbor &amp;&amp; <span class="hljs-built_in">mkdir</span> certs &amp;&amp; <span class="hljs-built_in">cd</span> certs<br><span class="hljs-comment"># 创建自签名证书</span><br>openssl genrsa -out certs/harbor-ca.key  <span class="hljs-comment"># 生成私钥</span><br><span class="hljs-built_in">touch</span> /root/.rnd<br>openssl req -x509 -new -nodes -key certs/harbor-ca.key -subj <span class="hljs-string">&quot;/CN=harbor.magedu.net&quot;</span> -days 7120 -out certs/harbor-ca.crt  <span class="hljs-comment"># 生成自签证书</span><br><span class="hljs-built_in">cp</span> harbor.yml.tmpl harbor.yml<br></code></pre></td></tr></table></figure>

<p>编辑harbor.yml配置文件：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@ha1 harbor]</span><span class="hljs-comment"># grep -v &#x27;#&#x27; harbor.yml | tr -s &#x27;\n&#x27;</span><br>hostname: harbor.magedu.net<br>http:<br>  port: 80<br>https:<br>  port: 443<br>  certificate: /data/soft/harbor/certs/harbor-ca.crt  <span class="hljs-comment"># 私钥路径</span><br>  private_key: /data/soft/harbor/certs/harbor-ca.key  <span class="hljs-comment"># 证书路径</span><br>harbor_admin_password: 123456  <span class="hljs-comment"># 默认admin密码</span><br>database:<br>  password: root123<br>  max_idle_conns: 100<br>  max_open_conns: 900<br>data_volume: /data/harbor<br>trivy:<br>  ignore_unfixed: false<br>  skip_update: false<br>  insecure: false<br>jobservice:<br>  max_job_workers: 10<br>notification:<br>  webhook_job_max_retry: 10<br>chart:<br>  absolute_url: disabled<br>log:<br>  level: info<br>  local:<br>    rotate_count: 50<br>    rotate_size: 200M<br>    location: /var/log/harbor<br>_version: 2.3.0<br>proxy:<br>  http_proxy:<br>  https_proxy:<br>  no_proxy:<br>  components:<br>    - core<br>    - jobservice<br>    - trivy<br></code></pre></td></tr></table></figure>

<p><code>./prepare</code>，准备配置文件（更新配置）</p>
<p><img src="https://s2.loli.net/2022/04/16/KN8UadPh7ZE9LXM.png" alt="image-20220412182211896"></p>
<p><code>./install.sh --help</code>查看帮助，<code>./install.sh --with-trivy</code>执行安装:</p>
<p><img src="https://s2.loli.net/2022/04/16/hR8ZbmLFQXW6TxU.png" alt="image-20220412182440001"></p>
<p>出现如下提示安装成功，查看镜像</p>
<p><img src="https://s2.loli.net/2022/04/16/o82n3MCxIRJ1wGv.png" alt="image-20220412182515745"></p>
<p><img src="https://s2.loli.net/2022/04/16/Ju7hcDqXTnt8a5C.png" alt="image-20220412182537130"></p>
<p>打开浏览器，输入HARBORIP, 用户名admin, 密码填写harbor.xml中设置密码进入管理页面：</p>
<p><img src="https://s2.loli.net/2022/04/16/tgCSsnUjLXdKcHY.png" alt="image-20220412182653326"></p>
<h3 id="3-3-harbor安装使用踩的坑"><a href="#3-3-harbor安装使用踩的坑" class="headerlink" title="3.3 harbor安装使用踩的坑"></a>3.3 harbor安装使用踩的坑</h3><ol>
<li>在配置完Harbor 后发现push 功能不可用出现以下问题</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@ha1 harbor]<span class="hljs-comment"># docker push harbor.magedu.net/test/centos-base:7</span><br>The push refers to repository [harbor.magedu.net/test/centos-base]<br>076db42d2a09: Preparing<br>174f56854903: Preparing<br>unauthorized: unauthorized to access repository: <span class="hljs-built_in">test</span>/centos-base, action: push: unauthorized to access repository: <span class="hljs-built_in">test</span>/centos-base, action: push<br></code></pre></td></tr></table></figure>

<p>解决方式：</p>
<p>查看 ~&#x2F;.docker&#x2F;config.json：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">[</span>root@ha1 harbor<span class="hljs-punctuation">]</span># cat ~/.docker/config.json<br><span class="hljs-punctuation">&#123;</span><br>		<span class="hljs-attr">&quot;harbor.magedu.net:443&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;auth&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;YWRtaW46MTIzNDU2&quot;</span><br>		<span class="hljs-punctuation">&#125;</span><br>	<span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>猜测登陆信息获取不对，修改登录地址再次登陆：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@ha1 harbor]<span class="hljs-comment"># docker login harbor.magedu.net/test/centos-base</span><br>Username: admin<br>Password:<br>WARNING! Your password will be stored unencrypted <span class="hljs-keyword">in</span> /root/.docker/config.json.<br>Configure a credential helper to remove this warning. See<br>https://docs.docker.com/engine/reference/commandline/login/<span class="hljs-comment">#credentials-store</span><br><br>Login Succeeded<br></code></pre></td></tr></table></figure>

<p>此时查看 ~&#x2F;.docker&#x2F;config.json：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@ha1 harbor]<span class="hljs-comment"># cat ~/.docker/config.json</span><br>&#123;<br>	<span class="hljs-string">&quot;auths&quot;</span>: &#123;<br>		<span class="hljs-string">&quot;harbor.magedu.net&quot;</span>: &#123;<br>			<span class="hljs-string">&quot;auth&quot;</span>: <span class="hljs-string">&quot;dGVzdDpEZHJiZGd6eUAwMDE=&quot;</span><br>		&#125;,<br>		<span class="hljs-string">&quot;harbor.magedu.net:443&quot;</span>: &#123;<br>			<span class="hljs-string">&quot;auth&quot;</span>: <span class="hljs-string">&quot;YWRtaW46MTIzNDU2&quot;</span><br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>再次push到harbor成功：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@ha1 harbor]<span class="hljs-comment"># docker push harbor.magedu.net/test/centos-base:7</span><br>The push refers to repository [harbor.magedu.net/test/centos-base]<br>076db42d2a09: Pushed<br>174f56854903: Pushed<br>7: digest: sha256:f24bb6fa09e33d9737a7e9385106f1e40624de4be2a111c027b579d9a9e8054a size: 742<br></code></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/04/16/Zs2F6M7rUu8aDmz.png" alt="image-20220413174334373"></p>
<ol start="2">
<li>push时提示证书错误</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@ha1 harbor]<span class="hljs-comment"># docker push harbor.magedu.net/test/centos-base:7</span><br>The push refers to repository [harbor.magedu.net/test/centos-base]<br>Get <span class="hljs-string">&quot;https://harbor.magedu.net/v2/&quot;</span>: x509: certificate signed by unknown authority<br></code></pre></td></tr></table></figure>

<p>解决方式：</p>
<p>修改&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;docker.service，增加 –insecure-registry 参数</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">ExecStart=<span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/dockerd --insecure-registry harbor.magedu.net -H fd:/</span><span class="hljs-regexp">/ --containerd=/</span>run<span class="hljs-regexp">/containerd/</span>containerd.sock<br></code></pre></td></tr></table></figure>

<p>重新加载配置、重启docker:</p>
<figure class="highlight nsis"><table><tr><td class="code"><pre><code class="hljs nsis"><span class="hljs-params">system</span>ctl daemon-reload<br><span class="hljs-params">system</span>ctl restart docker<br></code></pre></td></tr></table></figure>



<p>3.push时报legacy Common Name field, use SANs or temporarily enable Common Name matching with GODEBUG&#x3D;x509ignoreCN&#x3D;0</p>
<p>解决方法：</p>
<p>因为 go 1.15 版本开始<a target="_blank" rel="noopener" href="https://golang.org/doc/go1.15#commonname">废弃 CommonName</a>，因此推荐使用 SAN 证书。 如果想兼容之前的方式，需要设置环境变量 GODEBUG 为 <code>x509ignoreCN=0</code>，参考：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><code class="hljs stata">openssl genrsa -<span class="hljs-keyword">out</span> <span class="hljs-keyword">ca</span>.key 2048<br>openssl req -new -x509 -days 365 -key <span class="hljs-keyword">ca</span>.key -subj <span class="hljs-string">&quot;/C=CN/ST=GD/L=SZ/O=Acme, Inc./CN=Acme Root CA&quot;</span> -<span class="hljs-keyword">out</span> <span class="hljs-keyword">ca</span>.crt<br><br>openssl req -newkey rsa:2048 -nodes -keyout server.key -subj <span class="hljs-string">&quot;/C=CN/ST=GD/L=SZ/O=Acme, Inc./CN=*.example.com&quot;</span> -<span class="hljs-keyword">out</span> server.csr<br>openssl x509 -req -extfile &lt;(printf <span class="hljs-string">&quot;subjectAltName=DNS:example.com,DNS:www.example.com&quot;</span>) -days 365 -<span class="hljs-keyword">in</span> server.csr -<span class="hljs-keyword">CA</span> <span class="hljs-keyword">ca</span>.crt -CAkey <span class="hljs-keyword">ca</span>.key -CAcreateserial -<span class="hljs-keyword">out</span> server.crt<br></code></pre></td></tr></table></figure>

<p>接下来在&#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;创建对应目录并拷贝生成的证书：</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><code class="hljs gradle">[root@ha1 harbor]# mkdir -pv <span class="hljs-regexp">/etc/</span>docker<span class="hljs-regexp">/certs.d/</span>harbor.magedu.net:<span class="hljs-number">443</span><br>mkdir: 已创建目录 <span class="hljs-string">&quot;/etc/docker/certs.d/harbor.magedu.net:443&quot;</span><br>[root@ha1 harbor]# cp certs<span class="hljs-regexp">/harbor-ca.crt /</span>etc<span class="hljs-regexp">/docker/</span>certs.d<span class="hljs-regexp">/harbor.magedu.net:443/</span><br></code></pre></td></tr></table></figure>



<h2 id="4-etcd-安装"><a href="#4-etcd-安装" class="headerlink" title="4 etcd 安装"></a>4 etcd 安装</h2><p><img src="https://s2.loli.net/2022/04/16/X92arLoTweYKJPN.png" alt="image-20210421170705957"></p>
<p>etcd是Kubernetes集群的大脑。使用etcd的“Watch”功能监控更改序列。通过这个功能，Kubernetes可以订阅集群内的更改并执行来自API服务器的任何状态请求。etcd与分布式集群中的不同组件协作。etcd对组件状态的更改作出反应，其他组件可能会对更改作出反应。</p>
<p>可能存在这样一种情况：在维护集群中一组etcd组件的所有状态的相同副本时，需要将相同的数据存储在两个etcd实例中。但是，etcd不应该在不同的实例中更新相同的记录。</p>
<p>在这种情况下，etcd不会处理每个集群节点上的写操作。相反，只有一个实例负责在内部处理写操作。那个节点叫做leader。集群内其他节点采用RAFT算法选择一个leader。一旦leader选定，其他节点就成为follower节点。</p>
<p>现在，当写请求到达leader节点时，leader处理写入。leader etcd节点向其他节点广播数据的副本。如果一个follower节点在那一刻处于不活动或脱机状态，那么基于大多数可用节点，写请求将得到一个完整的标志。通常，如果leader得到集群中其他成员的同意，写操作将获得完整标志。</p>
<p>这是它们选择leader，以及如何确保在所有实例中传播写操作的方式。利用raft协议在etcd中实现了这种分布式共识。</p>
<p>最好采用奇数搭建etcd集群, 本次采用三节点搭建高可用集群</p>
<h3 id="4-1-创建TLS证书和密钥"><a href="#4-1-创建TLS证书和密钥" class="headerlink" title="4.1 创建TLS证书和密钥"></a>4.1 创建TLS证书和密钥</h3><p>前往下载cloudfare的 PKI 工具集 <a target="_blank" rel="noopener" href="https://github.com/cloudflare/cfssl">cfssl</a> 来生成 Certificate Authority (CA) 和其它证书</p>
<p><strong>生成的 CA 证书和秘钥文件如下：</strong></p>
<ul>
<li>ca-key.pem</li>
<li>ca.pem</li>
<li>kubernetes-key.pem</li>
<li>kubernetes.pem</li>
<li>kube-proxy.pem</li>
<li>kube-proxy-key.pem</li>
<li>admin.pem</li>
<li>admin-key.pem</li>
</ul>
<p><strong>使用证书的组件如下：</strong></p>
<ul>
<li>etcd：使用 ca.pem、kubernetes-key.pem、kubernetes.pem；</li>
<li>kube-apiserver：使用 ca.pem、kubernetes-key.pem、kubernetes.pem；</li>
<li>kubelet：使用 ca.pem；</li>
<li>kube-proxy：使用 ca.pem、kube-proxy-key.pem、kube-proxy.pem；</li>
<li>kubectl：使用 ca.pem、admin-key.pem、admin.pem；</li>
<li>kube-controller-manager：使用 ca-key.pem、ca.pem</li>
</ul>
<h4 id="创建-CA-Certificate-Authority"><a href="#创建-CA-Certificate-Authority" class="headerlink" title="创建 CA (Certificate Authority)"></a>创建 CA (Certificate Authority)</h4><p><strong>创建 CA 配置文件</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> /root/ssl<br><span class="hljs-built_in">cd</span> /root/ssl<br>cfssl print-defaults config &gt; config.json<br>cfssl print-defaults csr &gt; csr.json<br><span class="hljs-comment"># 根据config.json文件的格式创建如下的ca-config.json文件</span><br><span class="hljs-comment"># 过期时间设置成了 87600h</span><br><span class="hljs-built_in">cat</span> &gt; ca-config.json &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;signing&quot;: &#123;</span><br><span class="hljs-string">    &quot;default&quot;: &#123;</span><br><span class="hljs-string">      &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="hljs-string">    &#125;,</span><br><span class="hljs-string">    &quot;profiles&quot;: &#123;</span><br><span class="hljs-string">      &quot;kubernetes&quot;: &#123;</span><br><span class="hljs-string">        &quot;usages&quot;: [</span><br><span class="hljs-string">            &quot;signing&quot;,</span><br><span class="hljs-string">            &quot;key encipherment&quot;,</span><br><span class="hljs-string">            &quot;server auth&quot;,</span><br><span class="hljs-string">            &quot;client auth&quot;</span><br><span class="hljs-string">        ],</span><br><span class="hljs-string">        &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="hljs-string">      &#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">  &#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<p>字段说明</p>
<ul>
<li><code>ca-config.json</code>：可以定义多个 profiles，分别指定不同的过期时间、使用场景等参数；后续在签名证书时使用某个 profile；</li>
<li><code>signing</code>：表示该证书可用于签名其它证书；生成的 ca.pem 证书中 <code>CA=TRUE</code>；</li>
<li><code>server auth</code>：表示client可以用该 CA 对server提供的证书进行验证；</li>
<li><code>client auth</code>：表示server可以用该CA对client提供的证书进行验证；</li>
</ul>
<h4 id="创建-CA-证书签名请求"><a href="#创建-CA-证书签名请求" class="headerlink" title="创建 CA 证书签名请求"></a>创建 CA 证书签名请求</h4><p>创建 <code>ca-csr.json</code> 文件，内容如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;CN&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;kubernetes&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;key&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;algo&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;rsa&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2048</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;names&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;C&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;CN&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;ST&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;BeiJing&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;L&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;BeiJing&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;O&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;k8s&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;OU&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;System&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;ca&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>       <span class="hljs-attr">&quot;expiry&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;87600h&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>“CN”：<code>Common Name</code>，kube-apiserver 从证书中提取该字段作为请求的用户名 (User Name)；浏览器使用该字段验证网站是否合法；</li>
<li>“O”：<code>Organization</code>，kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)；</li>
</ul>
<h4 id="生成-CA-证书和私钥"><a href="#生成-CA-证书和私钥" class="headerlink" title="生成 CA 证书和私钥"></a>生成 CA 证书和私钥</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">$ cfssl gencert -initca ca-csr.json | cfssljson -bare ca<br>$ <span class="hljs-built_in">ls</span> ca*<br>ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem<br></code></pre></td></tr></table></figure>



<p>（后面的证书不是给etcd而是k8s的其他组件使用的）</p>
<h4 id="创建-kubernetes-证书"><a href="#创建-kubernetes-证书" class="headerlink" title="创建 kubernetes 证书"></a>创建 kubernetes 证书</h4><p>创建 kubernetes 证书签名请求文件 <code>kubernetes-csr.json</code>：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;CN&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;kubernetes&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hosts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>      <span class="hljs-string">&quot;127.0.0.1&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-string">&quot;172.20.0.112&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-string">&quot;172.20.0.113&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-string">&quot;172.20.0.114&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-string">&quot;172.20.0.115&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-string">&quot;10.254.0.1&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-string">&quot;kubernetes&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-string">&quot;kubernetes.default&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-string">&quot;kubernetes.default.svc&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-string">&quot;kubernetes.default.svc.cluster&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-string">&quot;kubernetes.default.svc.cluster.local&quot;</span><br>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;key&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;algo&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;rsa&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2048</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;names&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;C&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;CN&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;ST&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;BeiJing&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;L&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;BeiJing&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;O&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;k8s&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;OU&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;System&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>如果 hosts 字段不为空则需要指定授权使用该证书的 <strong>IP 或域名列表</strong>，由于该证书后续被 <code>etcd</code> 集群和 <code>kubernetes master</code> 集群使用，所以上面分别指定了 <code>etcd</code> 集群、<code>kubernetes master</code> 集群的主机 IP 和 <strong><code>kubernetes</code> 服务的服务 IP</strong>（一般是 <code>kube-apiserver</code> 指定的 <code>service-cluster-ip-range</code> 网段的第一个IP，如 10.254.0.1）。</li>
<li>这是最小化安装的kubernetes集群，包括一个私有镜像仓库，三个节点的kubernetes集群，以上物理节点的IP也可以更换为主机名。</li>
</ul>
<h4 id="生成-kubernetes-证书和私钥"><a href="#生成-kubernetes-证书和私钥" class="headerlink" title="生成 kubernetes 证书和私钥"></a>生成 kubernetes 证书和私钥</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes<br>$ <span class="hljs-built_in">ls</span> kubernetes*<br>kubernetes.csr  kubernetes-csr.json  kubernetes-key.pem  kubernetes.pem<br></code></pre></td></tr></table></figure>

<p>或者直接在命令行上指定相关参数：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;&#123;&quot;CN&quot;:&quot;kubernetes&quot;,&quot;hosts&quot;:[&quot;&quot;],&quot;key&quot;:&#123;&quot;algo&quot;:&quot;rsa&quot;,&quot;size&quot;:2048&#125;&#125;&#x27;</span> | cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes -hostname=<span class="hljs-string">&quot;127.0.0.1,172.20.0.112,172.20.0.113,172.20.0.114,172.20.0.115,kubernetes,kubernetes.default&quot;</span> - | cfssljson -bare kubernetes<br></code></pre></td></tr></table></figure>

<h4 id="创建-admin-证书"><a href="#创建-admin-证书" class="headerlink" title="创建 admin 证书"></a>创建 admin 证书</h4><p>创建 admin 证书签名请求文件 <code>admin-csr.json</code>：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;CN&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;admin&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;hosts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;key&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;algo&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;rsa&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2048</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;names&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;C&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;CN&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;ST&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;BeiJing&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;L&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;BeiJing&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;O&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;system:masters&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;OU&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;System&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>后续 <code>kube-apiserver</code> 使用 <code>RBAC</code> 对客户端(如 <code>kubelet</code>、<code>kube-proxy</code>、<code>Pod</code>)请求进行授权；</li>
<li><code>kube-apiserver</code> 预定义了一些 <code>RBAC</code> 使用的 <code>RoleBindings</code>，如 <code>cluster-admin</code> 将 Group <code>system:masters</code> 与 Role <code>cluster-admin</code> 绑定，该 Role 授予了调用<code>kube-apiserver</code> 的<strong>所有 API</strong>的权限；</li>
<li>O 指定该证书的 Group 为 <code>system:masters</code>，<code>kubelet</code> 使用该证书访问 <code>kube-apiserver</code> 时 ，由于证书被 CA 签名，所以认证通过，同时由于证书用户组为经过预授权的 <code>system:masters</code>，所以被授予访问所有 API 的权限；</li>
</ul>
<p><strong>注意</strong>：这个admin 证书，是将来生成管理员用的kube config 配置文件用的，现在我们一般建议使用RBAC 来对kubernetes 进行角色权限控制， kubernetes 将证书中的CN 字段 作为User， O 字段作为 Group（具体参考<a target="_blank" rel="noopener" href="https://jimmysong.io/kubernetes-handbook/guide/authentication.html"> Kubernetes中的用户与身份认证授权</a>中 X509 Client Certs 一段）。</p>
<p>在搭建完 kubernetes 集群后，我们可以通过命令: <code>kubectl get clusterrolebinding cluster-admin -o yaml</code> ,查看到 <code>clusterrolebinding cluster-admin</code> 的 subjects 的 kind 是 Group，name 是 <code>system:masters</code>。 <code>roleRef</code> 对象是 <code>ClusterRole cluster-admin</code>。 意思是凡是 <code>system:masters Group</code> 的 user 或者 <code>serviceAccount</code> 都拥有 <code>cluster-admin</code> 的角色。 因此我们在使用 kubectl 命令时候，才拥有整个集群的管理权限。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">$</span> <span class="hljs-string">kubectl</span> <span class="hljs-string">get</span> <span class="hljs-string">clusterrolebinding</span> <span class="hljs-string">cluster-admin</span> <span class="hljs-string">-o</span> <span class="hljs-string">yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">rbac.authorization.kubernetes.io/autoupdate:</span> <span class="hljs-string">&quot;true&quot;</span><br>  <span class="hljs-attr">creationTimestamp:</span> <span class="hljs-number">2017-04-11T11:20:42Z</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">kubernetes.io/bootstrapping:</span> <span class="hljs-string">rbac-defaults</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">cluster-admin</span><br>  <span class="hljs-attr">resourceVersion:</span> <span class="hljs-string">&quot;52&quot;</span><br>  <span class="hljs-attr">selfLink:</span> <span class="hljs-string">/apis/rbac.authorization.k8s.io/v1/clusterrolebindings/cluster-admin</span><br>  <span class="hljs-attr">uid:</span> <span class="hljs-string">e61b97b2-1ea8-11e7-8cd7-f4e9d49f8ed0</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">cluster-admin</span><br><span class="hljs-attr">subjects:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">Group</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">system:masters</span><br></code></pre></td></tr></table></figure>

<p>生成 admin 证书和私钥：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin<br>$ <span class="hljs-built_in">ls</span> admin*<br>admin.csr  admin-csr.json  admin-key.pem  admin.pem<br></code></pre></td></tr></table></figure>

<h4 id="创建-kube-proxy-证书"><a href="#创建-kube-proxy-证书" class="headerlink" title="创建 kube-proxy 证书"></a>创建 kube-proxy 证书</h4><p>创建 kube-proxy 证书签名请求文件 <code>kube-proxy-csr.json</code>：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;CN&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;system:kube-proxy&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;hosts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;key&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;algo&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;rsa&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2048</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;names&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;C&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;CN&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;ST&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;BeiJing&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;L&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;BeiJing&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;O&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;k8s&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;OU&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;System&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>CN 指定该证书的 User 为 <code>system:kube-proxy</code>；</li>
<li><code>kube-apiserver</code> 预定义的 RoleBinding <code>system:node-proxier</code> 将User <code>system:kube-proxy</code> 与 Role <code>system:node-proxier</code> 绑定，该 Role 授予了调用 <code>kube-apiserver</code> Proxy 相关 API 的权限；</li>
</ul>
<p>生成 kube-proxy 客户端证书和私钥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy<br>$ <span class="hljs-built_in">ls</span> kube-proxy*<br>kube-proxy.csr  kube-proxy-csr.json  kube-proxy-key.pem  kube-proxy.pem<br></code></pre></td></tr></table></figure>

<h4 id="校验证书"><a href="#校验证书" class="headerlink" title="校验证书"></a>校验证书</h4><p>以 Kubernetes 证书为例。</p>
<p>使用 <code>openssl</code> 命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">$ openssl x509  -noout -text -<span class="hljs-keyword">in</span>  kubernetes.pem<br>...<br>    Signature Algorithm: sha256WithRSAEncryption<br>        Issuer: C=CN, ST=BeiJing, L=BeiJing, O=k8s, OU=System, CN=Kubernetes<br>        Validity<br>            Not Before: Apr  5 05:36:00 2017 GMT<br>            Not After : Apr  5 05:36:00 2018 GMT<br>        Subject: C=CN, ST=BeiJing, L=BeiJing, O=k8s, OU=System, CN=kubernetes<br>...<br>        X509v3 extensions:<br>            X509v3 Key Usage: critical<br>                Digital Signature, Key Encipherment<br>            X509v3 Extended Key Usage:<br>                TLS Web Server Authentication, TLS Web Client Authentication<br>            X509v3 Basic Constraints: critical<br>                CA:FALSE<br>            X509v3 Subject Key Identifier:<br>                DD:52:04:43:10:13:A9:29:24:17:3A:0E:D7:14:DB:36:F8:6C:E0:E0<br>            X509v3 Authority Key Identifier:<br>                keyid:44:04:3B:60:BD:69:78:14:68:AF:A0:41:13:F6:17:07:13:63:58:CD<br><br>            X509v3 Subject Alternative Name:<br>                DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster, DNS:kubernetes.default.svc.cluster.local, IP Address:127.0.0.1, IP Address:172.20.0.112, IP Address:172.20.0.113, IP Address:172.20.0.114, IP Address:172.20.0.115, IP Address:10.254.0.1<br>...<br></code></pre></td></tr></table></figure>

<ul>
<li>确认 <code>Issuer</code> 字段的内容和 <code>ca-csr.json</code> 一致；</li>
<li>确认 <code>Subject</code> 字段的内容和 <code>kubernetes-csr.json</code> 一致；</li>
<li>确认 <code>X509v3 Subject Alternative Name</code> 字段的内容和 <code>kubernetes-csr.json</code> 一致；</li>
<li>确认 <code>X509v3 Key Usage、Extended Key Usage</code> 字段的内容和 <code>ca-config.json</code> 中 <code>kubernetes</code> profile 一致；</li>
</ul>
<h4 id="使用-cfssl-certinfo-命令"><a href="#使用-cfssl-certinfo-命令" class="headerlink" title="使用 cfssl-certinfo 命令"></a>使用 <code>cfssl-certinfo</code> 命令</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">$ cfssl-certinfo -cert kubernetes.pem<br>...<br>&#123;<br>  <span class="hljs-string">&quot;subject&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;common_name&quot;</span>: <span class="hljs-string">&quot;kubernetes&quot;</span>,<br>    <span class="hljs-string">&quot;country&quot;</span>: <span class="hljs-string">&quot;CN&quot;</span>,<br>    <span class="hljs-string">&quot;organization&quot;</span>: <span class="hljs-string">&quot;k8s&quot;</span>,<br>    <span class="hljs-string">&quot;organizational_unit&quot;</span>: <span class="hljs-string">&quot;System&quot;</span>,<br>    <span class="hljs-string">&quot;locality&quot;</span>: <span class="hljs-string">&quot;BeiJing&quot;</span>,<br>    <span class="hljs-string">&quot;province&quot;</span>: <span class="hljs-string">&quot;BeiJing&quot;</span>,<br>    <span class="hljs-string">&quot;names&quot;</span>: [<br>      <span class="hljs-string">&quot;CN&quot;</span>,<br>      <span class="hljs-string">&quot;BeiJing&quot;</span>,<br>      <span class="hljs-string">&quot;BeiJing&quot;</span>,<br>      <span class="hljs-string">&quot;k8s&quot;</span>,<br>      <span class="hljs-string">&quot;System&quot;</span>,<br>      <span class="hljs-string">&quot;kubernetes&quot;</span><br>    ]<br>  &#125;,<br>  <span class="hljs-string">&quot;issuer&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;common_name&quot;</span>: <span class="hljs-string">&quot;Kubernetes&quot;</span>,<br>    <span class="hljs-string">&quot;country&quot;</span>: <span class="hljs-string">&quot;CN&quot;</span>,<br>    <span class="hljs-string">&quot;organization&quot;</span>: <span class="hljs-string">&quot;k8s&quot;</span>,<br>    <span class="hljs-string">&quot;organizational_unit&quot;</span>: <span class="hljs-string">&quot;System&quot;</span>,<br>    <span class="hljs-string">&quot;locality&quot;</span>: <span class="hljs-string">&quot;BeiJing&quot;</span>,<br>    <span class="hljs-string">&quot;province&quot;</span>: <span class="hljs-string">&quot;BeiJing&quot;</span>,<br>    <span class="hljs-string">&quot;names&quot;</span>: [<br>      <span class="hljs-string">&quot;CN&quot;</span>,<br>      <span class="hljs-string">&quot;BeiJing&quot;</span>,<br>      <span class="hljs-string">&quot;BeiJing&quot;</span>,<br>      <span class="hljs-string">&quot;k8s&quot;</span>,<br>      <span class="hljs-string">&quot;System&quot;</span>,<br>      <span class="hljs-string">&quot;Kubernetes&quot;</span><br>    ]<br>  &#125;,<br>  <span class="hljs-string">&quot;serial_number&quot;</span>: <span class="hljs-string">&quot;174360492872423263473151971632292895707129022309&quot;</span>,<br>  <span class="hljs-string">&quot;sans&quot;</span>: [<br>    <span class="hljs-string">&quot;kubernetes&quot;</span>,<br>    <span class="hljs-string">&quot;kubernetes.default&quot;</span>,<br>    <span class="hljs-string">&quot;kubernetes.default.svc&quot;</span>,<br>    <span class="hljs-string">&quot;kubernetes.default.svc.cluster&quot;</span>,<br>    <span class="hljs-string">&quot;kubernetes.default.svc.cluster.local&quot;</span>,<br>    <span class="hljs-string">&quot;127.0.0.1&quot;</span>,<br>    <span class="hljs-string">&quot;10.64.3.7&quot;</span>,<br>    <span class="hljs-string">&quot;10.254.0.1&quot;</span><br>  ],<br>  <span class="hljs-string">&quot;not_before&quot;</span>: <span class="hljs-string">&quot;2017-04-05T05:36:00Z&quot;</span>,<br>  <span class="hljs-string">&quot;not_after&quot;</span>: <span class="hljs-string">&quot;2018-04-05T05:36:00Z&quot;</span>,<br>  <span class="hljs-string">&quot;sigalg&quot;</span>: <span class="hljs-string">&quot;SHA256WithRSA&quot;</span>,<br>...<br></code></pre></td></tr></table></figure>

<p>复制所有证书到<code>/etc/etcd/</code>目录下备用</p>
<h3 id="4-2-安装配置etcd"><a href="#4-2-安装配置etcd" class="headerlink" title="4.2 安装配置etcd"></a>4.2 安装配置etcd</h3><p>实验环境</p>
<ul>
<li>node-1：192.168.68149</li>
<li>node-2：192.168.68.150</li>
<li>node-3：192.168.68.148</li>
</ul>
<h4 id="下载最新版本的etcd"><a href="#下载最新版本的etcd" class="headerlink" title="下载最新版本的etcd"></a>下载最新版本的etcd</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">https://github.com/etcd-io/etcd/releases<br><span class="hljs-comment"># 下载相应平台最新版解压之后，将 etcd、etcdctl 放入 /usr/bin</span><br><span class="hljs-comment"># 可执行权限 chmod +x /usr/bin/etcd*</span><br></code></pre></td></tr></table></figure>

<h4 id="创建-etcd-的-systemd-unit-文件"><a href="#创建-etcd-的-systemd-unit-文件" class="headerlink" title="创建 etcd 的 systemd unit 文件"></a>创建 etcd 的 systemd unit 文件</h4><p>在&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;目录下创建文件etcd.service，内容如下。注意替换IP地址为你自己的etcd集群的主机IP。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@ha1 etcd]<span class="hljs-comment"># cat /lib/systemd/system/etcd.service</span><br>[Unit]<br>Description=Etcd Server<br>After=network.target<br>After=network-online.target<br>Wants=network-online.target<br>Documentation=https://github.com/coreos<br><br>[Service]<br>Type=notify<br>WorkingDirectory=/var/lib/etcd/<br>EnvironmentFile=-/etc/etcd/etcd.conf<br>ExecStart=/usr/local/bin/etcd \<br>  --cert-file=/etc/kubernetes/ssl/kubernetes.pem \<br>  --key-file=/etc/kubernetes/ssl/kubernetes-key.pem \<br>  --peer-cert-file=/etc/kubernetes/ssl/kubernetes.pem \<br>  --peer-key-file=/etc/kubernetes/ssl/kubernetes-key.pem \<br>  --trusted-ca-file=/etc/kubernetes/ssl/ca.pem \<br>  --peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem \<br>  --initial-cluster infra1=https://192.168.68.149:2380,infra2=https://192.168.68.150:2380,infra3=https://192.168.68.148:2380 \<br>  --initial-cluster-state new<br>Restart=on-failure<br>RestartSec=5<br>LimitNOFILE=65536<br><br>[Install]<br>WantedBy=multi-user.target<br>[root@ha1 etcd]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<ul>
<li>指定 <code>etcd</code> 的工作目录为 <code>/var/lib/etcd</code>，数据目录为 <code>/var/lib/etcd</code>，需在启动服务前创建这个目录，否则启动服务的时候会报错“Failed at step CHDIR spawning &#x2F;usr&#x2F;bin&#x2F;etcd: No such file or directory”；</li>
<li>为了保证通信安全，需要指定 etcd 的公私钥(cert-file和key-file)、Peers 通信的公私钥和 CA 证书(peer-cert-file、peer-key-file、peer-trusted-ca-file)、客户端的CA证书（trusted-ca-file）；</li>
<li>创建 <code>kubernetes.pem</code> 证书时使用的 <code>kubernetes-csr.json</code> 文件的 <code>hosts</code> 字段<strong>包含所有 etcd 节点的IP</strong>，否则证书校验会出错；</li>
<li><code>--initial-cluster-state</code> 值为 <code>new</code> 时，<code>--name</code> 的参数值必须位于 <code>--initial-cluster</code> 列表中；</li>
</ul>
<h4 id="配置环境变量文件"><a href="#配置环境变量文件" class="headerlink" title="配置环境变量文件"></a>配置环境变量文件</h4><figure class="highlight ini"><table><tr><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@ha1 etcd]</span><span class="hljs-comment"># cat /etc/etcd/etcd.conf</span><br><span class="hljs-comment"># [member]</span><br><span class="hljs-attr">ETCD_NAME</span>=infra1<br><span class="hljs-attr">ETCD_DATA_DIR</span>=<span class="hljs-string">&quot;/var/lib/etcd&quot;</span><br><span class="hljs-attr">ETCD_LISTEN_PEER_URLS</span>=<span class="hljs-string">&quot;https://192.168.68.149:2380&quot;</span><br><span class="hljs-attr">ETCD_LISTEN_CLIENT_URLS</span>=<span class="hljs-string">&quot;https://192.168.68.149:2379&quot;</span><br><br><span class="hljs-comment">#[cluster]</span><br><span class="hljs-attr">ETCD_INITIAL_ADVERTISE_PEER_URLS</span>=<span class="hljs-string">&quot;https://192.168.68.149:2380&quot;</span><br><span class="hljs-attr">ETCD_INITIAL_CLUSTER_TOKEN</span>=<span class="hljs-string">&quot;etcd-cluster&quot;</span><br><span class="hljs-attr">ETCD_ADVERTISE_CLIENT_URLS</span>=<span class="hljs-string">&quot;https://192.168.68.149:2379&quot;</span><br><span class="hljs-section">[root@ha1 etcd]</span><span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<p>Node-2,Node-3配置与此类似,ETCD_NAME换成对应节点的infra2&#x2F;3</p>
<p>启动etcd服务：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># systemctl daemon-reload</span><br><span class="hljs-comment"># systemctl enable etcd</span><br><span class="hljs-comment"># systemctl start etcd</span><br><span class="hljs-comment"># systemctl status etcd</span><br></code></pre></td></tr></table></figure>



<h4 id="踩到的坑"><a href="#踩到的坑" class="headerlink" title="踩到的坑"></a>踩到的坑</h4><ul>
<li><p>启动etcd服务时报错</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">: &#123;&quot;level&quot;:&quot;fatal&quot;,&quot;ts&quot;:1649936424.1166,&quot;caller&quot;:&quot;flags/flag.go:85&quot;,&quot;msg&quot;:&quot;conflicting environment variable is shadowed by corresponding command-line flag (either unset environment variable or disable flag))&quot;,&quot;environment-variable&quot;:&quot;ETCD_DATA_DIR&quot;,&quot;stacktrace&quot;:&quot;go.etcd.io/etcd/pkg/v3/flags.verifyEnv\n\t/tmp/etcd-release-3.5.2/etc<br></code></pre></td></tr></table></figure></li>
</ul>
<p>environment variable定义重复了，比较新的版本etcd启动会自动读取<code>/etc/etcd/etcd.config</code>（或其他指定目录）中的变量，不需要重复再在<code>/lib/systemd/system/etcd.service</code>中的<code>ExecStart</code>重复指定</p>
<ul>
<li><code>cannot access data directory: directory &quot;/application/kubernetes/data/&quot;,&quot;drwxr-xr-x&quot; exist without desired file permission &quot;-rwx------&quot;.</code></li>
</ul>
<p>将权限设置为700即可</p>
<ul>
<li><p><code>etcdctl member list查看成员列表，显示leader cluster may be unhealthy: failed to list members Error:  unexpected status code 404</code></p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">解决1：etcdctl通过<span class="hljs-attribute">ETCDCTL_API</span>=3查询的member list就是没有leader信息的，需要通过API2.0进行查询。ETCD3.4版本<span class="hljs-attribute">ETCDCTL_API</span>=3 etcdctl 和 etcd <span class="hljs-attribute">--enable-v2</span>=<span class="hljs-literal">false</span> 成为了默认配置，进行API2.0进行查询需要如下设置：客户端：<span class="hljs-built_in">export</span> <span class="hljs-attribute">ETCDCTL_API</span>=2 服务端：etcd.config.yaml中增加enable-v2: <span class="hljs-literal">true</span>，并重启etcd服务。<br>解决2：<span class="hljs-attribute">API</span>=3，使用如下命令：ETCDCTL_API=3 etcdctl endpoint status --cluster -w table注意：etcd集群所有节点都要启动enable-v2： <span class="hljs-literal">true</span>，否则会出现在API2.0下执行etcdctl命令，时而成功、时而报“unexpected status code 404”<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="5-使用kubeadm部署工具安装k8s"><a href="#5-使用kubeadm部署工具安装k8s" class="headerlink" title="5 使用kubeadm部署工具安装k8s"></a>5 使用kubeadm部署工具安装k8s</h2><p>为了方便学习此处使用kubeadm方式安装，后续考虑使用二进制方式部署。实验环境：</p>
<table>
<thead>
<tr>
<th>host</th>
<th>CPU</th>
<th>RAM</th>
<th>IP</th>
</tr>
</thead>
<tbody><tr>
<td>master</td>
<td>2</td>
<td>2</td>
<td>192.168.68.151</td>
</tr>
<tr>
<td>node-1</td>
<td>2</td>
<td>2</td>
<td>192.168.68.149</td>
</tr>
<tr>
<td>node-2</td>
<td>2</td>
<td>2</td>
<td>192.168.68.150</td>
</tr>
<tr>
<td>node-3</td>
<td>2</td>
<td>2</td>
<td>192.168.68.148</td>
</tr>
</tbody></table>
<p>系统：CentOS Linux release 7.9.2009 (Core), 内核版本：3.10.0-1160.62.1.el7.x86_64</p>
<h3 id="5-1-安装前准备"><a href="#5-1-安装前准备" class="headerlink" title="5.1 安装前准备"></a>5.1 安装前准备</h3><h4 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h4><ul>
<li>一台兼容的 Linux 主机。Kubernetes 项目为基于 Debian 和 Red Hat 的 Linux 发行版以及一些不提供包管理器的发行版提供通用的指令</li>
<li>每台机器 2 GB 或更多的 RAM （如果少于这个数字将会影响你应用的运行内存)</li>
<li>2 CPU 核或更多</li>
<li>集群中的所有机器的网络彼此均能相互连接(公网和内网都可以)</li>
<li>节点之中不可以有重复的主机名、MAC 地址或 product_uuid。请参见<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#verify-mac-address">这里</a>了解更多详细信息。</li>
<li>开启机器上的某些端口。请参见<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#check-required-ports">这里</a> 了解更多详细信息。</li>
<li>禁用交换分区。为了保证 kubelet 正常工作，你 <strong>必须</strong> 禁用交换分区。</li>
</ul>
<h4 id="确保每个节点上-MAC-地址和-product-uuid-的唯一性"><a href="#确保每个节点上-MAC-地址和-product-uuid-的唯一性" class="headerlink" title="确保每个节点上 MAC 地址和 product_uuid 的唯一性"></a>确保每个节点上 MAC 地址和 product_uuid 的唯一性</h4><ul>
<li>你可以使用命令 <code>ip link</code> 或 <code>ifconfig -a</code> 来获取网络接口的 MAC 地址</li>
<li>可以使用 <code>sudo cat /sys/class/dmi/id/product_uuid</code> 命令对 product_uuid 校验</li>
</ul>
<p>一般来讲，硬件设备会拥有唯一的地址，但是有些虚拟机的地址可能会重复。 Kubernetes 使用这些值来唯一确定集群中的节点。 如果这些值在每个节点上不唯一，可能会导致安装 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubeadm/issues/31">失败</a>。</p>
<h4 id="允许-iptables-检查桥接流量"><a href="#允许-iptables-检查桥接流量" class="headerlink" title="允许 iptables 检查桥接流量"></a>允许 iptables 检查桥接流量</h4><p>确保 <code>br_netfilter</code> 模块被加载。这一操作可以通过运行 <code>lsmod | grep br_netfilter</code> 来完成。若要显式加载该模块，可执行 <code>sudo modprobe br_netfilter</code>。</p>
<p>为了让你的 Linux 节点上的 iptables 能够正确地查看桥接流量，你需要确保在你的 <code>sysctl</code> 配置中将 <code>net.bridge.bridge-nf-call-iptables</code> 设置为 1。例如：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF | sudo tee /etc/modules-load.d/k8s.conf</span><br><span class="hljs-string">br_netfilter</span><br><span class="hljs-string">EOF</span><br><br><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF | sudo tee /etc/sysctl.d/k8s.conf</span><br><span class="hljs-string">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="hljs-string">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="hljs-string">EOF</span><br>sudo sysctl --system<br></code></pre></td></tr></table></figure>

<h4 id="安装-runtime"><a href="#安装-runtime" class="headerlink" title="安装 runtime"></a>安装 runtime</h4><p>默认情况下，Kubernetes 使用 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/overview/components/#container-runtime">容器运行时接口（Container Runtime Interface，CRI）</a> 来与你所选择的容器运行时交互。</p>
<p>如果你不指定运行时，则 kubeadm 会自动尝试检测到系统上已经安装的运行时， 方法是扫描一组众所周知的 Unix 域套接字。 下面的表格列举了一些容器运行时及其对应的套接字路径：</p>
<table>
<thead>
<tr>
<th>运行时</th>
<th>域套接字</th>
</tr>
</thead>
<tbody><tr>
<td>Docker</td>
<td>&#x2F;var&#x2F;run&#x2F;dockershim.sock</td>
</tr>
<tr>
<td>containerd</td>
<td>&#x2F;run&#x2F;containerd&#x2F;containerd.sock</td>
</tr>
<tr>
<td>CRI-O</td>
<td>&#x2F;var&#x2F;run&#x2F;crio&#x2F;crio.sock</td>
</tr>
</tbody></table>
<p>如果同时检测到 Docker 和 containerd，则优先选择 Docker。 这是必然的，因为 Docker 18.09 附带了 containerd 并且两者都是可以检测到的， 即使你仅安装了 Docker。 如果检测到其他两个或多个运行时，kubeadm 输出错误信息并退出。</p>
<p>kubelet 通过内置的 <code>dockershim</code> CRI 实现与 Docker 集成。</p>
<p>参阅<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/">容器运行时</a> 以了解更多信息。</p>
<h4 id="安装-kubeadm、kubelet-和-kubectl"><a href="#安装-kubeadm、kubelet-和-kubectl" class="headerlink" title="安装 kubeadm、kubelet 和 kubectl"></a>安装 kubeadm、kubelet 和 kubectl</h4><p>你需要在每台机器上安装以下的软件包：</p>
<ul>
<li><code>kubeadm</code>：用来初始化集群的指令。</li>
<li><code>kubelet</code>：在集群中的每个节点上用来启动 Pod 和容器等。</li>
<li><code>kubectl</code>：用来与集群通信的命令行工具。</li>
</ul>
<p>此处以阿里源安装为例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="hljs-string">&gt; [kubernetes]</span><br><span class="hljs-string">&gt; name=Kubernetes</span><br><span class="hljs-string">&gt; baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="hljs-string">&gt; enabled=1</span><br><span class="hljs-string">&gt; gpgcheck=1</span><br><span class="hljs-string">&gt; repo_gpgcheck=0</span><br><span class="hljs-string">&gt; gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="hljs-string">&gt; EOF</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>ps: 由于官网未开放同步方式, 可能会有索引gpg检查失败的情况, 这时请用 <code>yum install -y --nogpgcheck kubelet kubeadm kubectl</code> 安装；或者关闭<code>repo_gpgcheck</code>，否则yum安装时会报错<code>https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/repodata/repomd.xml: [Errno -1] repomd.xml signature could not be verified for kubernetes</code></p>
</blockquote>
<p>将 SELinux 设置为 permissive 模式（相当于将其禁用）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">setenforce 0<br>sed -i <span class="hljs-string">&#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27;</span> /etc/selinux/config<br></code></pre></td></tr></table></figure>

<p>安装kubeadm、kubelet 和 kubectl</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">yum install -y kubelet kubeadm kubectl <span class="hljs-attribute">--disableexcludes</span>=kubernetes<br>systemctl <span class="hljs-built_in">enable</span> --now kubelet<br></code></pre></td></tr></table></figure>

<p>关闭swap（1.8版本以后必须，否则报错）</p>
<ul>
<li>swapoff -a 临时关闭</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@master etc]<span class="hljs-comment"># swapoff -a  # 临时关闭</span><br>[root@master etc]<span class="hljs-comment"># free -m</span><br>              total        used        free      shared  buff/cache   available<br>Mem:           1980         312         134          17        1533        1486<br>Swap:             0           0           0<br></code></pre></td></tr></table></figure>

<ul>
<li>在&#x2F;etc&#x2F;fstab中注视掉swap（永久）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@master etc]<span class="hljs-comment">#sed -i &quot;s/\/dev\/mapper\/centos-swap/\#\/dev\/mapper\/centos-swap/g&quot; /etc/fstab</span><br>[root@master etc]<span class="hljs-comment"># mount -a # 修改后重新挂载全部挂载点</span><br></code></pre></td></tr></table></figure>



<h3 id="5-2-节点初始化"><a href="#5-2-节点初始化" class="headerlink" title="5.2 节点初始化"></a>5.2 节点初始化</h3><h4 id="master-节点初始化"><a href="#master-节点初始化" class="headerlink" title="master 节点初始化"></a>master 节点初始化</h4><p>初始化master节点，kubeadm init命令支持两种初始化方式，一是通过命令行选项传递关键的部署设定，另一个是基于yaml格式的专用配置文件，后一种允许用户自定义各个部署参数。</p>
<p>命令中的各选项简单说明如下：</p>
<ul>
<li>–pod-network-cidr：Pod网络的地址范围，其值为CIDR格式的网络地址，通常，Flannel网络插件的默认为10.244.0.0&#x2F;16，Project Calico插件的默认值为192.168.0.0&#x2F;16；</li>
<li>–service-cidr：Service的网络地址范围，其值为CIDR格式的网络地址，默认为10.96.0.0&#x2F;12；通常，<code>仅Flannel一类的网络插件需要手动指定该地址</code>；</li>
<li>–apiserver-advertise-address：apiserver通告给其他组件的IP地址，一般应该为Master节点的用于集群内部通信的IP地址，0.0.0.0表示节点上所有可用地址；</li>
<li>–token-ttl：共享令牌（token）的过期时长，默认为24小时，0表示永不过期；为防止不安全存储等原因导致的令牌泄露危及集群安全，建议为其设定过期时长。未设定该选项时，在token过期后，若期望再向集群中加入其它节点，可以使用如下命令重新创建token，并生成节点加入命令。</li>
</ul>
<p>有关 <code>kubeadm init</code> 参数的更多信息，请参见 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/">kubeadm 参考指南</a>。</p>
<p>要使用配置文件配置 <code>kubeadm init</code> 命令，请参见<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm-init/#config-file">带配置文件使用 kubeadm init</a>。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@master ~]<span class="hljs-comment">#   kubeadm init --apiserver-advertise-address=192.168.68.151 --service-cidr=10.1.0.0/16 --pod-network-cidr=10.244.0.0/16  # 151是mater本机的ip</span><br>[init] Using Kubernetes version: v1.23.5<br>[preflight] Running pre-flight checks<br>	[WARNING Firewalld]: firewalld is active, please ensure ports [6443 10250] are open or your cluster may not <span class="hljs-keyword">function</span> correctly<br>	[WARNING Service-Kubelet]: kubelet service is not enabled, please run <span class="hljs-string">&#x27;systemctl enable kubelet.service&#x27;</span><br>[preflight] Pulling images required <span class="hljs-keyword">for</span> setting up a Kubernetes cluster<br>[preflight] This might take a minute or two, depending on the speed of your internet connection<br>[preflight] You can also perform this action <span class="hljs-keyword">in</span> beforehand using <span class="hljs-string">&#x27;kubeadm config images pull&#x27;</span><br>[certs] Using certificateDir folder <span class="hljs-string">&quot;/etc/kubernetes/pki&quot;</span><br>[certs] Generating <span class="hljs-string">&quot;ca&quot;</span> certificate and key<br>[certs] Generating <span class="hljs-string">&quot;apiserver&quot;</span> certificate and key<br>[certs] apiserver serving cert is signed <span class="hljs-keyword">for</span> DNS names [kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local master] and IPs [10.1.0.1 192.168.68.151]<br>[certs] Generating <span class="hljs-string">&quot;apiserver-kubelet-client&quot;</span> certificate and key<br>[certs] Generating <span class="hljs-string">&quot;front-proxy-ca&quot;</span> certificate and key<br>[certs] Generating <span class="hljs-string">&quot;front-proxy-client&quot;</span> certificate and key<br>[certs] Generating <span class="hljs-string">&quot;etcd/ca&quot;</span> certificate and key<br>[certs] Generating <span class="hljs-string">&quot;etcd/server&quot;</span> certificate and key<br>[certs] etcd/server serving cert is signed <span class="hljs-keyword">for</span> DNS names [localhost master] and IPs [192.168.68.151 127.0.0.1 ::1]<br>[certs] Generating <span class="hljs-string">&quot;etcd/peer&quot;</span> certificate and key<br>[certs] etcd/peer serving cert is signed <span class="hljs-keyword">for</span> DNS names [localhost master] and IPs [192.168.68.151 127.0.0.1 ::1]<br>[certs] Generating <span class="hljs-string">&quot;etcd/healthcheck-client&quot;</span> certificate and key<br>[certs] Generating <span class="hljs-string">&quot;apiserver-etcd-client&quot;</span> certificate and key<br>[certs] Generating <span class="hljs-string">&quot;sa&quot;</span> key and public key<br>[kubeconfig] Using kubeconfig folder <span class="hljs-string">&quot;/etc/kubernetes&quot;</span><br>[kubeconfig] Writing <span class="hljs-string">&quot;admin.conf&quot;</span> kubeconfig file<br>[kubeconfig] Writing <span class="hljs-string">&quot;kubelet.conf&quot;</span> kubeconfig file<br>[kubeconfig] Writing <span class="hljs-string">&quot;controller-manager.conf&quot;</span> kubeconfig file<br>[kubeconfig] Writing <span class="hljs-string">&quot;scheduler.conf&quot;</span> kubeconfig file<br>[kubelet-start] Writing kubelet environment file with flags to file <span class="hljs-string">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span><br>[kubelet-start] Writing kubelet configuration to file <span class="hljs-string">&quot;/var/lib/kubelet/config.yaml&quot;</span><br>[kubelet-start] Starting the kubelet<br>[control-plane] Using manifest folder <span class="hljs-string">&quot;/etc/kubernetes/manifests&quot;</span><br>[control-plane] Creating static Pod manifest <span class="hljs-keyword">for</span> <span class="hljs-string">&quot;kube-apiserver&quot;</span><br>[control-plane] Creating static Pod manifest <span class="hljs-keyword">for</span> <span class="hljs-string">&quot;kube-controller-manager&quot;</span><br>[control-plane] Creating static Pod manifest <span class="hljs-keyword">for</span> <span class="hljs-string">&quot;kube-scheduler&quot;</span><br>[etcd] Creating static Pod manifest <span class="hljs-keyword">for</span> <span class="hljs-built_in">local</span> etcd <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;/etc/kubernetes/manifests&quot;</span><br>[wait-control-plane] Waiting <span class="hljs-keyword">for</span> the kubelet to boot up the control plane as static Pods from directory <span class="hljs-string">&quot;/etc/kubernetes/manifests&quot;</span>. This can take up to 4m0s<br>[apiclient] All control plane components are healthy after 6.003818 seconds<br>[upload-config] Storing the configuration used <span class="hljs-keyword">in</span> ConfigMap <span class="hljs-string">&quot;kubeadm-config&quot;</span> <span class="hljs-keyword">in</span> the <span class="hljs-string">&quot;kube-system&quot;</span> Namespace<br>[kubelet] Creating a ConfigMap <span class="hljs-string">&quot;kubelet-config-1.23&quot;</span> <span class="hljs-keyword">in</span> namespace kube-system with the configuration <span class="hljs-keyword">for</span> the kubelets <span class="hljs-keyword">in</span> the cluster<br>NOTE: The <span class="hljs-string">&quot;kubelet-config-1.23&quot;</span> naming of the kubelet ConfigMap is deprecated. Once the UnversionedKubeletConfigMap feature gate graduates to Beta the default name will become just <span class="hljs-string">&quot;kubelet-config&quot;</span>. Kubeadm upgrade will handle this transition transparently.<br>[upload-certs] Skipping phase. Please see --upload-certs<br>[mark-control-plane] Marking the node master as control-plane by adding the labels: [node-role.kubernetes.io/master(deprecated) node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]<br>[mark-control-plane] Marking the node master as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]<br>[bootstrap-token] Using token: v7a8ke.zqnhzofo3cn69lge<br>[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles<br>[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to get nodes<br>[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs <span class="hljs-keyword">in</span> order <span class="hljs-keyword">for</span> nodes to get long term certificate credentials<br>[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token<br>[bootstrap-token] configured RBAC rules to allow certificate rotation <span class="hljs-keyword">for</span> all node client certificates <span class="hljs-keyword">in</span> the cluster<br>[bootstrap-token] Creating the <span class="hljs-string">&quot;cluster-info&quot;</span> ConfigMap <span class="hljs-keyword">in</span> the <span class="hljs-string">&quot;kube-public&quot;</span> namespace<br>[kubelet-finalize] Updating <span class="hljs-string">&quot;/etc/kubernetes/kubelet.conf&quot;</span> to point to a rotatable kubelet client certificate and key<br>[addons] Applied essential addon: CoreDNS<br>[addons] Applied essential addon: kube-proxy<br><br>Your Kubernetes control-plane has initialized successfully!<br><br>To start using your cluster, you need to run the following as a regular user:<br><br>  <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/.kube<br>  sudo <span class="hljs-built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config<br>  sudo <span class="hljs-built_in">chown</span> $(<span class="hljs-built_in">id</span> -u):$(<span class="hljs-built_in">id</span> -g) <span class="hljs-variable">$HOME</span>/.kube/config<br><br>Alternatively, <span class="hljs-keyword">if</span> you are the root user, you can run:<br><br>  <span class="hljs-built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf<br><br>You should now deploy a pod network to the cluster.<br>Run <span class="hljs-string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:<br>  https://kubernetes.io/docs/concepts/cluster-administration/addons/<br><br>Then you can <span class="hljs-built_in">join</span> any number of worker nodes by running the following on each as root:<br><br>kubeadm <span class="hljs-built_in">join</span> 192.168.68.151:6443 --token v7a8ke.zqnhzofo3cn69lge \<br>	--discovery-token-ca-cert-hash sha256:6d362f1c226c8e8ae42a87f57608264104b58abd7ec5cfde4795353eba8c4a11<br></code></pre></td></tr></table></figure>

<p>初始化前可以输入<code>kubeadm config images pull</code> 事先拉取相关镜像, 加快初始化速度</p>
<p>如果<code>kubeadm</code>初始化时出现问题，参考官方<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/troubleshooting-kubeadm/">故障排查手册</a></p>
<p>按照说明，添加cluster相关配置：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 普通用户</span><br><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/.kube<br>sudo <span class="hljs-built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config<br>sudo <span class="hljs-built_in">chown</span> $(<span class="hljs-built_in">id</span> -u):$(<span class="hljs-built_in">id</span> -g) <span class="hljs-variable">$HOME</span>/.kube/config<br><span class="hljs-comment"># root用户</span><br><span class="hljs-built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf<br></code></pre></td></tr></table></figure>

<p>此时检查 pods， 发现 coredns 在pending，是因为在等待网络插件的安装</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@master .kube]<span class="hljs-comment"># kubectl get pods --all-namespaces</span><br>NAMESPACE     NAME                             READY   STATUS    RESTARTS   AGE<br>kube-system   coredns-64897985d-7d9cf          0/1     Pending   0          17m<br>kube-system   coredns-64897985d-gdkpg          0/1     Pending   0          17m<br>kube-system   etcd-master                      1/1     Running   0          17m<br>kube-system   kube-apiserver-master            1/1     Running   0          17m<br>kube-system   kube-controller-manager-master   1/1     Running   0          17m<br>kube-system   kube-proxy-4cv47                 1/1     Running   0          17m<br>kube-system   kube-scheduler-master            1/1     Running   1          17m<br></code></pre></td></tr></table></figure>

<p>还有非常重要的一步是 <strong>部署网络插件</strong> ,参考 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/cluster-administration/networking/#how-to-implement-the-kubernetes-networking-model">插件列表</a> ， 这里我们选择安装 <a target="_blank" rel="noopener" href="https://github.com/flannel-io/flannel#flannel">Flannel</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@master ~]<span class="hljs-comment"># kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br>Warning: policy/v1beta1 PodSecurityPolicy is deprecated <span class="hljs-keyword">in</span> v1.21+, unavailable <span class="hljs-keyword">in</span> v1.25+<br>podsecuritypolicy.policy/psp.flannel.unprivileged created<br>clusterrole.rbac.authorization.k8s.io/flannel created<br>clusterrolebinding.rbac.authorization.k8s.io/flannel created<br>serviceaccount/flannel created<br>configmap/kube-flannel-cfg created<br>daemonset.apps/kube-flannel-ds created<br></code></pre></td></tr></table></figure>

<p>此时再次检查pods:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">## 此时coredns的pods也变成了Running状态</span><br>[root@master ~]<span class="hljs-comment"># kubectl get pods -A</span><br>NAMESPACE     NAME                             READY   STATUS    RESTARTS   AGE<br>kube-system   coredns-64897985d-7d9cf          0/1     Running   0          130m<br>kube-system   coredns-64897985d-gdkpg          0/1     Running   0          130m<br>kube-system   etcd-master                      1/1     Running   0          131m<br>kube-system   kube-apiserver-master            1/1     Running   0          131m<br>kube-system   kube-controller-manager-master   1/1     Running   0          131m<br>kube-system   kube-flannel-ds-5kwrh            1/1     Running   0          95s<br>kube-system   kube-proxy-4cv47                 1/1     Running   0          130m<br>kube-system   kube-scheduler-master            1/1     Running   1          131m<br><br><span class="hljs-comment">## 此时只有一个node</span><br>[root@master ~]<span class="hljs-comment"># kubectl get nodes</span><br>NAME     STATUS   ROLES                  AGE    VERSION<br>master   Ready    control-plane,master   132m   v1.23.5<br></code></pre></td></tr></table></figure>



<h4 id="slave节点加入集群"><a href="#slave节点加入集群" class="headerlink" title="slave节点加入集群"></a>slave节点加入集群</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@node-1 ~]<span class="hljs-comment"># kubeadm join 192.168.68.151:6443 --token v7a8ke.zqnhzofo3cn69lge --discovery-token-ca-cert-hash sha256:6d362f1c226c8e8ae42a87f57608264104b58abd7ec5cfde4795353eba8c4a11</span><br>[preflight] Running pre-flight checks<br>^C<br>[root@node-1 ~]<span class="hljs-comment"># kubeadm join 192.168.68.151:6443 --token v7a8ke.zqnhzofo3cn69lge --discovery-token-ca-cert-hash sha256:6d362f1c226c8e8ae42a87f57608264104b58abd7ec5cfde4795353eba8c4a11</span><br>[preflight] Running pre-flight checks<br>[preflight] Reading configuration from the cluster...<br>[preflight] FYI: You can look at this config file with <span class="hljs-string">&#x27;kubectl -n kube-system get cm kubeadm-config -o yaml&#x27;</span><br>[kubelet-start] Writing kubelet configuration to file <span class="hljs-string">&quot;/var/lib/kubelet/config.yaml&quot;</span><br>[kubelet-start] Writing kubelet environment file with flags to file <span class="hljs-string">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span><br>[kubelet-start] Starting the kubelet<br>[kubelet-start] Waiting <span class="hljs-keyword">for</span> the kubelet to perform the TLS Bootstrap...<br><br>This node has joined the cluster:<br>* Certificate signing request was sent to apiserver and a response was received.<br>* The Kubelet was informed of the new secure connection details.<br><br>Run <span class="hljs-string">&#x27;kubectl get nodes&#x27;</span> on the control-plane to see this node <span class="hljs-built_in">join</span> the cluster.<br></code></pre></td></tr></table></figure>

<p>如法炮制将node-2、node-3 也加入，此时查看nodes状态，由notready变为ready</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@master ~]<span class="hljs-comment"># kubectl get nodes</span><br>NAME     STATUS     ROLES                  AGE    VERSION<br>master   Ready      control-plane,master   167m   v1.23.5<br>node-1   NotReady   &lt;none&gt;                 40s    v1.23.5<br>node-2   NotReady   &lt;none&gt;                 45s    v1.23.5<br>node-3   NotReady   &lt;none&gt;                 61s    v1.23.5<br>[root@master ~]<span class="hljs-comment"># kubectl get nodes</span><br>NAME     STATUS   ROLES                  AGE     VERSION<br>master   Ready    control-plane,master   173m    v1.23.5<br>node-1   Ready    &lt;none&gt;                 6m33s   v1.23.5<br>node-2   Ready    &lt;none&gt;                 6m38s   v1.23.5<br>node-3   Ready    &lt;none&gt;                 6m54s   v1.23.5<br></code></pre></td></tr></table></figure>

<p>查看pods</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@master ~]<span class="hljs-comment"># kubectl get pods -A</span><br>NAMESPACE     NAME                             READY   STATUS    RESTARTS   AGE<br>kube-system   coredns-64897985d-7d9cf          1/1     Running   0          177m<br>kube-system   coredns-64897985d-gdkpg          1/1     Running   0          177m<br>kube-system   etcd-master                      1/1     Running   0          177m<br>kube-system   kube-apiserver-master            1/1     Running   0          177m<br>kube-system   kube-controller-manager-master   1/1     Running   0          177m<br>kube-system   kube-flannel-ds-5kwrh            1/1     Running   0          48m<br>kube-system   kube-flannel-ds-hgcb4            1/1     Running   0          10m<br>kube-system   kube-flannel-ds-hmthh            1/1     Running   0          10m<br>kube-system   kube-flannel-ds-w7wl5            1/1     Running   0          10m<br>kube-system   kube-proxy-2mk4k                 1/1     Running   0          10m<br>kube-system   kube-proxy-4cv47                 1/1     Running   0          177m<br>kube-system   kube-proxy-s6d6h                 1/1     Running   0          10m<br>kube-system   kube-proxy-zlj2x                 1/1     Running   0          10m<br>kube-system   kube-scheduler-master            1/1     Running   1          177m<br></code></pre></td></tr></table></figure>

<p>至此一个master，三个node的kubernetes集群基础设施已经部署完成</p>
<h3 id="5-x-踩到的坑"><a href="#5-x-踩到的坑" class="headerlink" title="5.x 踩到的坑"></a>5.x 踩到的坑</h3><ul>
<li><p>kubeadm 初始化报错<code>18797 server.go:302] &quot;Failed to run kubelet&quot; err=&quot;failed to run Kubelet: misconfiguration: kubelet cgroup driver: \&quot;systemd\&quot; is different from docker cgroup driver: \&quot;cgroupfs\&quot;&quot;</code></p>
<p>原因</p>
<p>　kubernetes1.14之后的版本推荐使用systemd,但docker默认的Cgroup Driver 是Cgroup，使得kubelet部署报错</p>
<p>解决方案</p>
<p>修改docker配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF | sudo tee /etc/docker/daemon.json</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="hljs-string">  &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="hljs-string">  &quot;log-opts&quot;: &#123;</span><br><span class="hljs-string">    &quot;max-size&quot;: &quot;100m&quot;</span><br><span class="hljs-string">  &#125;,</span><br><span class="hljs-string">  &quot;storage-driver&quot;: &quot;overlay2&quot;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<p>完成后重启docker</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">systemctl <span class="hljs-built_in">enable</span> docker<br>systemctl daemon-reload<br>systemctl restart docker<br></code></pre></td></tr></table></figure>
</li>
<li><p>kubeadm初始化时拉取镜像超时，</p>
<p>原因 谷歌repo被墙</p>
<p>解决方案</p>
<p><code>kubeadm init</code>初始化时加入<code>--image-repository registry.aliyuncs.com/google_containers</code>, 或者在上一步中更换为阿里源</p>
</li>
</ul>

    </div>

    
    
    
        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Ops/" rel="tag"># Ops</a>
              <a href="/tags/k8s/" rel="tag"># k8s</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/07/11/SaltStack%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E6%B7%B1%E5%85%A5salt%E5%86%85%E9%83%A8/" rel="prev" title="SaltStack学习笔记-深入salt内部">
      <i class="fa fa-chevron-left"></i> SaltStack学习笔记-深入salt内部
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/04/29/%E4%BD%BF%E7%94%A8kubeasz%E5%AE%89%E8%A3%85k8s%E9%9B%86%E7%BE%A4/" rel="next" title="使用kubeasz安装k8s集群">
      使用kubeasz安装k8s集群 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#K8s%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E5%8F%8A%E5%AE%89%E8%A3%85%EF%BC%88kubeadm%E6%96%B9%E5%BC%8F%EF%BC%89"><span class="nav-number">1.</span> <span class="nav-text">K8s环境部署及安装（kubeadm方式）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-CentOS-%E5%AE%89%E8%A3%85%E5%8F%8A%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">1.1.</span> <span class="nav-text">1 CentOS 安装及初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%88%87%E6%8D%A2%E9%98%BF%E9%87%8C%E6%BA%90"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.1 切换阿里源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E5%88%87%E6%8D%A2epel%E6%BA%90"><span class="nav-number">1.1.2.</span> <span class="nav-text">1.2 切换epel源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E5%AE%89%E8%A3%85%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-number">1.1.3.</span> <span class="nav-text">1.3 安装常用命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-%E5%AE%89%E8%A3%85docker-ce"><span class="nav-number">1.1.4.</span> <span class="nav-text">1.4 安装docker-ce</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-k8s%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E8%A7%84%E5%88%92%E4%BF%A1%E6%81%AF%EF%BC%9A"><span class="nav-number">1.1.5.</span> <span class="nav-text">1.5 k8s高可用集群环境规划信息：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5-1-%E5%8D%95master%E7%8E%AF%E5%A2%83"><span class="nav-number">1.1.5.1.</span> <span class="nav-text">1.5.1 单master环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5-2-%E5%A4%9Amaster%E7%8E%AF%E5%A2%83"><span class="nav-number">1.1.5.2.</span> <span class="nav-text">1.5.2 多master环境</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-haproxy%E5%8F%8A-keepalived-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85"><span class="nav-number">1.2.</span> <span class="nav-text">2 haproxy及 keepalived 高可用集群安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E5%AE%89%E8%A3%85haproxy"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1 安装haproxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E5%AE%89%E8%A3%85keepalived"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.2 安装keepalived</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E9%83%A8%E7%BD%B2harbor%E4%BB%93%E5%BA%93"><span class="nav-number">1.3.</span> <span class="nav-text">3 部署harbor仓库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E5%AE%89%E8%A3%85docker-ce"><span class="nav-number">1.3.1.</span> <span class="nav-text">3.1 安装docker-ce</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hardware"><span class="nav-number">1.3.2.</span> <span class="nav-text">Hardware</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Software"><span class="nav-number">1.3.3.</span> <span class="nav-text">Software</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85harbor"><span class="nav-number">1.3.4.</span> <span class="nav-text">3.2 下载安装harbor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-harbor%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8%E8%B8%A9%E7%9A%84%E5%9D%91"><span class="nav-number">1.3.5.</span> <span class="nav-text">3.3 harbor安装使用踩的坑</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-etcd-%E5%AE%89%E8%A3%85"><span class="nav-number">1.4.</span> <span class="nav-text">4 etcd 安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E5%88%9B%E5%BB%BATLS%E8%AF%81%E4%B9%A6%E5%92%8C%E5%AF%86%E9%92%A5"><span class="nav-number">1.4.1.</span> <span class="nav-text">4.1 创建TLS证书和密钥</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-CA-Certificate-Authority"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">创建 CA (Certificate Authority)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-CA-%E8%AF%81%E4%B9%A6%E7%AD%BE%E5%90%8D%E8%AF%B7%E6%B1%82"><span class="nav-number">1.4.1.2.</span> <span class="nav-text">创建 CA 证书签名请求</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%9F%E6%88%90-CA-%E8%AF%81%E4%B9%A6%E5%92%8C%E7%A7%81%E9%92%A5"><span class="nav-number">1.4.1.3.</span> <span class="nav-text">生成 CA 证书和私钥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-kubernetes-%E8%AF%81%E4%B9%A6"><span class="nav-number">1.4.1.4.</span> <span class="nav-text">创建 kubernetes 证书</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%9F%E6%88%90-kubernetes-%E8%AF%81%E4%B9%A6%E5%92%8C%E7%A7%81%E9%92%A5"><span class="nav-number">1.4.1.5.</span> <span class="nav-text">生成 kubernetes 证书和私钥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-admin-%E8%AF%81%E4%B9%A6"><span class="nav-number">1.4.1.6.</span> <span class="nav-text">创建 admin 证书</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-kube-proxy-%E8%AF%81%E4%B9%A6"><span class="nav-number">1.4.1.7.</span> <span class="nav-text">创建 kube-proxy 证书</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%A1%E9%AA%8C%E8%AF%81%E4%B9%A6"><span class="nav-number">1.4.1.8.</span> <span class="nav-text">校验证书</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-cfssl-certinfo-%E5%91%BD%E4%BB%A4"><span class="nav-number">1.4.1.9.</span> <span class="nav-text">使用 cfssl-certinfo 命令</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEetcd"><span class="nav-number">1.4.2.</span> <span class="nav-text">4.2 安装配置etcd</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%E7%9A%84etcd"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">下载最新版本的etcd</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-etcd-%E7%9A%84-systemd-unit-%E6%96%87%E4%BB%B6"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">创建 etcd 的 systemd unit 文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%96%87%E4%BB%B6"><span class="nav-number">1.4.2.3.</span> <span class="nav-text">配置环境变量文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B8%A9%E5%88%B0%E7%9A%84%E5%9D%91"><span class="nav-number">1.4.2.4.</span> <span class="nav-text">踩到的坑</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E4%BD%BF%E7%94%A8kubeadm%E9%83%A8%E7%BD%B2%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85k8s"><span class="nav-number">1.5.</span> <span class="nav-text">5 使用kubeadm部署工具安装k8s</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E5%AE%89%E8%A3%85%E5%89%8D%E5%87%86%E5%A4%87"><span class="nav-number">1.5.1.</span> <span class="nav-text">5.1 安装前准备</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E8%A6%81%E6%B1%82"><span class="nav-number">1.5.1.1.</span> <span class="nav-text">环境要求</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A1%AE%E4%BF%9D%E6%AF%8F%E4%B8%AA%E8%8A%82%E7%82%B9%E4%B8%8A-MAC-%E5%9C%B0%E5%9D%80%E5%92%8C-product-uuid-%E7%9A%84%E5%94%AF%E4%B8%80%E6%80%A7"><span class="nav-number">1.5.1.2.</span> <span class="nav-text">确保每个节点上 MAC 地址和 product_uuid 的唯一性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%81%E8%AE%B8-iptables-%E6%A3%80%E6%9F%A5%E6%A1%A5%E6%8E%A5%E6%B5%81%E9%87%8F"><span class="nav-number">1.5.1.3.</span> <span class="nav-text">允许 iptables 检查桥接流量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-runtime"><span class="nav-number">1.5.1.4.</span> <span class="nav-text">安装 runtime</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-kubeadm%E3%80%81kubelet-%E5%92%8C-kubectl"><span class="nav-number">1.5.1.5.</span> <span class="nav-text">安装 kubeadm、kubelet 和 kubectl</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E8%8A%82%E7%82%B9%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">1.5.2.</span> <span class="nav-text">5.2 节点初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#master-%E8%8A%82%E7%82%B9%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">1.5.2.1.</span> <span class="nav-text">master 节点初始化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#slave%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4"><span class="nav-number">1.5.2.2.</span> <span class="nav-text">slave节点加入集群</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-x-%E8%B8%A9%E5%88%B0%E7%9A%84%E5%9D%91"><span class="nav-number">1.5.3.</span> <span class="nav-text">5.x 踩到的坑</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="QinTianJun"
      src="/images/logo.jpeg">
  <p class="site-author-name" itemprop="name">QinTianJun</p>
  <div class="site-description" itemprop="description">一个菜鸟的成长之路</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/qtj1215" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;qtj1215" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:freedom1215@foxmail.com" title="E-Mail → mailto:freedom1215@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.qintianjun.top/atom.xml" title="RSS → https:&#x2F;&#x2F;www.qintianjun.top&#x2F;atom.xml"><i class="fas fa-rss fa-fw"></i></a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">QinTianJun</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动<br>
    <a href="https://beian.miit.gov.cn/" target="_blank">ICP备案号</a>
    <a href="https://beian.miit.gov.cn/" target="_blank">沪ICP备2023025470号-1</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
